PHPUnit 11.5.42 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12 with PCOV 1.0.12
Configuration: /opt/nestogy/phpunit.xml

Migrated 19 permissions to Bouncer abilities.
Migrated 0 roles to Bouncer.
Migrated 0 role-permission relationships across 0 companies.
Migrated 0 user role assignments.
Migrated 0 direct user permissions.
Dropped legacy permission system tables.
The system now uses Bouncer for role and permission management.
EE........EF...F.                                                 17 / 17 (100%)

Time: 00:17.371, Memory: 119.00 MB

Contract Generation Service (Tests\Unit\Services\ContractGenerationService)
 ✘ Generate from quote creates contract
   │
   │ Illuminate\Database\QueryException: SQLSTATE[42703]: Undefined column: 7 ERROR:  column "is_recurring" does not exist
   │ LINE 1: ...$1 and "invoice_items"."quote_id" is not null and "is_recurr...
   │                                                              ^ (Connection: pgsql, SQL: select sum("subtotal") as aggregate from "invoice_items" where "invoice_items"."quote_id" = 1 and "invoice_items"."quote_id" is not null and "is_recurring" = 1 and "invoice_items"."company_id" = 1 and "invoice_items"."archived_at" is null)
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:824
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3188
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3173
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3763
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3172
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3687
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3648
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:52
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Relations/Relation.php:538
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:639
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:333
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:69
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:58
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:54
   │  
   │ Caused by:
   │ PDOException: SQLSTATE[42703]: Undefined column: 7 ERROR:  column "is_recurring" does not exist
   │ LINE 1: ...$1 and "invoice_items"."quote_id" is not null and "is_recurr...
   │                                                              ^
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:411
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:811
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3188
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3173
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3763
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3172
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3687
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3648
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:52
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Relations/Relation.php:538
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:639
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:333
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:69
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:58
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:54
   │
 ✘ Generate from quote with customizations
   │
   │ Illuminate\Database\QueryException: SQLSTATE[42703]: Undefined column: 7 ERROR:  column "is_recurring" does not exist
   │ LINE 1: ...$1 and "invoice_items"."quote_id" is not null and "is_recurr...
   │                                                              ^ (Connection: pgsql, SQL: select sum("subtotal") as aggregate from "invoice_items" where "invoice_items"."quote_id" = 2 and "invoice_items"."quote_id" is not null and "is_recurring" = 1 and "invoice_items"."company_id" = 5 and "invoice_items"."archived_at" is null)
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:824
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3188
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3173
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3763
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3172
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3687
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3648
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:52
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Relations/Relation.php:538
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:639
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:333
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:69
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:58
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:80
   │  
   │ Caused by:
   │ PDOException: SQLSTATE[42703]: Undefined column: 7 ERROR:  column "is_recurring" does not exist
   │ LINE 1: ...$1 and "invoice_items"."quote_id" is not null and "is_recurr...
   │                                                              ^
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:411
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:811
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3188
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3173
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3763
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3172
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3687
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3648
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:52
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Relations/Relation.php:538
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:639
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:333
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:69
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:58
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:80
   │
 ✔ Generate from template creates contract
 ✔ Generate from template with voip config
 ✔ Create custom contract
 ✔ Create custom contract with milestones
 ✔ Generate contract document
 ✔ Generate contract document with options
 ✔ Regenerate contract
 ✔ Regenerate contract maintains original data
 ✘ Full contract lifecycle from quote
   │
   │ Exception: Quote must be fully approved before generating contract
   │
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:283
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:66
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:58
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:269
   │
 ✘ Contract generation with multiple templates
   │
   │ Failed asserting that two strings are equal.
   │ --- Expected
   │ +++ Actual
   │ @@ @@
   │ -'managed_services'
   │ +'custom'
   │
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:308
   │
 ✔ Contract generation handles company isolation
 ✔ Generate from quote validates quote status
 ✔ Create custom contract requires minimum fields
 ✘ Regenerate contract handles signed contracts
   │
   │ Failed asserting that exception of type "Exception" is thrown.

   │
 ✔ Generate contract document handles missing contract

ERRORS!
Tests: 17, Assertions: 22, Errors: 3, Failures: 2.

Generating code coverage report in Clover XML format ... done [00:12.648]
