PHPUnit 11.5.42 by Sebastian Bergmann and contributors.

Runtime:       PHP 8.4.12 with PCOV 1.0.12
Configuration: /opt/nestogy/phpunit.xml

Migrated 19 permissions to Bouncer abilities.
Migrated 0 roles to Bouncer.
Migrated 0 role-permission relationships across 0 companies.
Migrated 0 user role assignments.
Migrated 0 direct user permissions.
Dropped legacy permission system tables.
The system now uses Bouncer for role and permission management.
EE..EE....EF...F.                                                 17 / 17 (100%)

Time: 00:17.484, Memory: 119.00 MB

Contract Generation Service (Tests\Unit\Services\ContractGenerationService)
 ✘ Generate from quote creates contract
   │
   │ Exception: Quote must be accepted before generating contract
   │
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:272
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:66
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:58
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:54
   │
 ✘ Generate from quote with customizations
   │
   │ Exception: Quote must be accepted before generating contract
   │
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:272
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:66
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:58
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:80
   │
 ✔ Generate from template creates contract
 ✔ Generate from template with voip config
 ✘ Create custom contract
   │
   │ Illuminate\Database\QueryException: SQLSTATE[23502]: Not null violation: 7 ERROR:  null value in column "contract_type" of relation "contracts" violates not-null constraint
   │ DETAIL:  Failing row contains (3, 11, CNT-0001, null, Custom Contract, Custom contract for special services, draft, 5, 15000.00, USD, null, 0.00, 0.00, 2025-10-05, 2026-04-05, null, null, null, null, null, null, f, null, null, null, null, 9, null, null, null, f, null, null, null, null, 2025-10-05 07:55:46, 2025-10-05 07:55:46, null, pending, fixed, null, null, null, null, null, null, null, null, null, null, null, null, 0, 0, 0.00, 0.00, 0.00, null, null, f, t, f, null, f, null, null, null, null, null, null, null, null, null, null). (Connection: pgsql, SQL: insert into "contracts" ("company_id", "contract_number", "currency_code", "status", "signature_status", "created_by", "client_id", "title", "start_date", "end_date", "contract_value", "description", "updated_at", "created_at") values (11, CNT-0001, USD, draft, pending, 9, 5, Custom Contract, 2025-10-05 00:00:00, 2026-04-05 00:00:00, 15000, Custom contract for special services, 2025-10-05 07:55:46, 2025-10-05 07:55:46) returning "id")
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:824
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:384
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Processors/PostgresProcessor.php:24
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3853
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1436
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1401
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1240
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1219
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/helpers.php:390
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1218
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2540
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2556
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:152
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:143
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:145
   │  
   │ Caused by:
   │ PDOException: SQLSTATE[23502]: Not null violation: 7 ERROR:  null value in column "contract_type" of relation "contracts" violates not-null constraint
   │ DETAIL:  Failing row contains (3, 11, CNT-0001, null, Custom Contract, Custom contract for special services, draft, 5, 15000.00, USD, null, 0.00, 0.00, 2025-10-05, 2026-04-05, null, null, null, null, null, null, f, null, null, null, null, 9, null, null, null, f, null, null, null, null, 2025-10-05 07:55:46, 2025-10-05 07:55:46, null, pending, fixed, null, null, null, null, null, null, null, null, null, null, null, null, 0, 0, 0.00, 0.00, 0.00, null, null, f, t, f, null, f, null, null, null, null, null, null, null, null, null, null).
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:411
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:811
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:384
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Processors/PostgresProcessor.php:24
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3853
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1436
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1401
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1240
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1219
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/helpers.php:390
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1218
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2540
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2556
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:152
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:143
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:145
   │
 ✘ Create custom contract with milestones
   │
   │ Illuminate\Database\QueryException: SQLSTATE[23502]: Not null violation: 7 ERROR:  null value in column "contract_type" of relation "contracts" violates not-null constraint
   │ DETAIL:  Failing row contains (4, 12, CNT-0001, null, Project Contract, null, draft, 6, 0.00, USD, null, 0.00, 0.00, 2025-10-05, null, null, null, null, null, null, null, f, null, null, null, null, 10, null, null, null, f, null, null, null, null, 2025-10-05 07:55:46, 2025-10-05 07:55:46, null, pending, fixed, null, null, null, null, null, null, null, null, null, null, null, null, 0, 0, 0.00, 0.00, 0.00, null, null, f, t, f, null, f, null, null, null, null, null, null, null, null, null, null). (Connection: pgsql, SQL: insert into "contracts" ("company_id", "contract_number", "currency_code", "status", "signature_status", "created_by", "client_id", "title", "start_date", "updated_at", "created_at") values (12, CNT-0001, USD, draft, pending, 10, 6, Project Contract, 2025-10-05 00:00:00, 2025-10-05 07:55:46, 2025-10-05 07:55:46) returning "id")
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:824
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:384
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Processors/PostgresProcessor.php:24
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3853
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1436
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1401
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1240
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1219
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/helpers.php:390
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1218
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2540
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2556
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:152
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:143
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:175
   │  
   │ Caused by:
   │ PDOException: SQLSTATE[23502]: Not null violation: 7 ERROR:  null value in column "contract_type" of relation "contracts" violates not-null constraint
   │ DETAIL:  Failing row contains (4, 12, CNT-0001, null, Project Contract, null, draft, 6, 0.00, USD, null, 0.00, 0.00, 2025-10-05, null, null, null, null, null, null, null, f, null, null, null, null, 10, null, null, null, f, null, null, null, null, 2025-10-05 07:55:46, 2025-10-05 07:55:46, null, pending, fixed, null, null, null, null, null, null, null, null, null, null, null, null, 0, 0, 0.00, 0.00, 0.00, null, null, f, t, f, null, f, null, null, null, null, null, null, null, null, null, null).
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:411
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:811
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:384
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Processors/PostgresProcessor.php:24
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3853
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1436
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1401
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1240
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1219
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/helpers.php:390
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:1218
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Traits/ForwardsCalls.php:23
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2540
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:2556
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:152
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Concerns/ManagesTransactions.php:35
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php:489
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Support/Facades/Facade.php:363
   │ /opt/nestogy/app/Domains/Contract/Services/ContractGenerationService.php:143
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:175
   │
 ✔ Generate contract document
 ✔ Generate contract document with options
 ✔ Regenerate contract
 ✔ Regenerate contract maintains original data
 ✘ Full contract lifecycle from quote
   │
   │ Illuminate\Database\QueryException: SQLSTATE[23514]: Check violation: 7 ERROR:  new row for relation "contract_templates" violates check constraint "contract_templates_status_check"
   │ DETAIL:  Failing row contains (5, 21, ipsam quia qui, veritatis-eos-atque-consequatur-eius-suscipit-minus-non, null, compliance, null, null, inactive, 1.0, null, f, null, null, ["client_id","start_date","end_date"], hybrid, null, null, null, null, 223.35, null, null, 9.36, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, 0, null, null, f, null, null, null, null, null, null, 19, null, null, 2025-10-05 07:55:48, 2025-10-05 07:55:48, null, null). (Connection: pgsql, SQL: insert into "contract_templates" ("company_id", "name", "slug", "description", "template_type", "category", "tags", "status", "version", "parent_template_id", "is_default", "variable_fields", "default_values", "required_fields", "voip_service_types", "default_sla_terms", "default_pricing_structure", "compliance_templates", "jurisdictions", "regulatory_requirements", "legal_disclaimers", "customization_options", "conditional_clauses", "pricing_models", "billing_model", "asset_billing_rules", "supported_asset_types", "asset_service_matrix", "default_per_asset_rate", "contact_billing_rules", "contact_access_tiers", "default_per_contact_rate", "calculation_formulas", "auto_assignment_rules", "billing_triggers", "workflow_automation", "notification_triggers", "integration_hooks", "usage_count", "last_used_at", "success_rate", "requires_approval", "approval_workflow", "last_reviewed_at", "next_review_date", "metadata", "rendering_options", "signature_settings", "created_by", "updated_by", "approved_by", "updated_at", "created_at") values (21, ipsam quia qui, veritatis-eos-atque-consequatur-eius-suscipit-minus-non, ?, compliance, ?, ?, inactive, 1.0, ?, 0, ?, ?, ["client_id","start_date","end_date"], ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, hybrid, ?, ?, ?, 223.35, ?, ?, 9.36, ?, ?, ?, ?, ?, ?, 0, ?, ?, 0, ?, ?, ?, ?, ?, ?, 19, ?, ?, 2025-10-05 07:55:48, 2025-10-05 07:55:48) returning "id")
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:824
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:384
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Processors/PostgresProcessor.php:24
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3853
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1436
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1401
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1240
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:370
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Collections/Traits/EnumeratesValues.php:271
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:365
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:321
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:315
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:264
   │  
   │ Caused by:
   │ PDOException: SQLSTATE[23514]: Check violation: 7 ERROR:  new row for relation "contract_templates" violates check constraint "contract_templates_status_check"
   │ DETAIL:  Failing row contains (5, 21, ipsam quia qui, veritatis-eos-atque-consequatur-eius-suscipit-minus-non, null, compliance, null, null, inactive, 1.0, null, f, null, null, ["client_id","start_date","end_date"], hybrid, null, null, null, null, 223.35, null, null, 9.36, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, 0, null, null, f, null, null, null, null, null, null, 19, null, null, 2025-10-05 07:55:48, 2025-10-05 07:55:48, null, null).
   │
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:411
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:811
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:778
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:397
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Connection.php:384
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Processors/PostgresProcessor.php:24
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Query/Builder.php:3853
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Builder.php:2235
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1436
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1401
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Model.php:1240
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:370
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Collections/Traits/EnumeratesValues.php:271
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:365
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:321
   │ /opt/nestogy/vendor/laravel/framework/src/Illuminate/Database/Eloquent/Factories/Factory.php:315
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:264
   │
 ✘ Contract generation with multiple templates
   │
   │ Failed asserting that two strings are equal.
   │ --- Expected
   │ +++ Actual
   │ @@ @@
   │ -'managed_services'
   │ +'custom'
   │
   │ /opt/nestogy/tests/Unit/Services/ContractGenerationServiceTest.php:308
   │
 ✔ Contract generation handles company isolation
 ✔ Generate from quote validates quote status
 ✔ Create custom contract requires minimum fields
 ✘ Regenerate contract handles signed contracts
   │
   │ Failed asserting that exception of type "Exception" is thrown.

   │
 ✔ Generate contract document handles missing contract

ERRORS!
Tests: 17, Assertions: 17, Errors: 5, Failures: 2.

Generating code coverage report in Clover XML format ... done [00:12.735]
