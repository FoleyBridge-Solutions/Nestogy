# Nestogy ERP - Apache Virtual Host Configuration
# Place this file in /etc/apache2/sites-available/

# HTTP Configuration
<VirtualHost *:80>
    ServerName nestogy.local
    ServerAlias www.nestogy.local
    
    # Document root points to Laravel's public directory
    DocumentRoot /var/www/html/nestogy-laravel/public
    
    # Directory configuration
    <Directory /var/www/html/nestogy-laravel/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Additional security headers
        Header set X-Content-Type-Options "nosniff"
        Header set X-Frame-Options "SAMEORIGIN"
        Header set X-XSS-Protection "1; mode=block"
    </Directory>
    
    # Deny access to sensitive files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <Files ".env">
        Require all denied
    </Files>
    
    # Log files
    ErrorLog ${APACHE_LOG_DIR}/nestogy-error.log
    CustomLog ${APACHE_LOG_DIR}/nestogy-access.log combined
    
    # PHP configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/run/php/php8.2-fpm.sock|fcgi://localhost"
    </FilesMatch>
</VirtualHost>

# HTTPS Configuration
<VirtualHost *:443>
    ServerName nestogy.local
    ServerAlias www.nestogy.local
    
    # Document root
    DocumentRoot /var/www/html/nestogy-laravel/public
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/nestogy.crt
    SSLCertificateKeyFile /etc/ssl/private/nestogy.key
    # SSLCertificateChainFile /etc/ssl/certs/nestogy-chain.crt
    
    # Modern SSL configuration
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder on
    
    # HSTS (optional but recommended)
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # Directory configuration
    <Directory /var/www/html/nestogy-laravel/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Security headers
        Header set X-Content-Type-Options "nosniff"
        Header set X-Frame-Options "SAMEORIGIN"
        Header set X-XSS-Protection "1; mode=block"
        Header set Referrer-Policy "strict-origin-when-cross-origin"
        Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
    </Directory>
    
    # Deny access to sensitive files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
    <Files ".env">
        Require all denied
    </Files>
    
    # Log files
    ErrorLog ${APACHE_LOG_DIR}/nestogy-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/nestogy-ssl-access.log combined
    
    # PHP configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/run/php/php8.2-fpm.sock|fcgi://localhost"
    </FilesMatch>
</VirtualHost>

# Production Configuration Example
# Uncomment and modify for production use
#
# <VirtualHost *:80>
#     ServerName erp.yourcompany.com
#     # Redirect all HTTP to HTTPS
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
# </VirtualHost>
#
# <VirtualHost *:443>
#     ServerName erp.yourcompany.com
#     DocumentRoot /var/www/nestogy/public
#     
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/erp.yourcompany.com/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/erp.yourcompany.com/privkey.pem
#     
#     # ... rest of configuration ...
# </VirtualHost>