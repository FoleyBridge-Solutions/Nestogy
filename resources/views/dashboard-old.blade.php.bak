@extends('layouts.app')

@section('title', 'Dashboard')

@section('content')
<div x-data="modernDashboard()" x-init="init()" class="space-y-6">
    <!-- Dashboard Header with Flux UI -->
    <div class="flex items-center justify-between">
        <div>
            <flux:heading size="xl">
                @php
                    $workflowTitles = [
                        'urgent' => 'Urgent Items Dashboard',
                        'today' => "Today's Work Dashboard", 
                        'scheduled' => 'Scheduled Work Dashboard',
                        'financial' => 'Financial Dashboard',
                        'reports' => 'Reports Dashboard',
                        'default' => 'Executive Dashboard'
                    ];
                    $currentWorkflow = $workflow ?? $workflowView ?? 'default';
                @endphp
                {{ $workflowTitles[$currentWorkflow] ?? 'Executive Dashboard' }}
            </flux:heading>
            
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                @if($selectedClient ?? null)
                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-zinc-100 text-zinc-800 dark:bg-zinc-800 dark:text-zinc-200">{{ $selectedClient->name }}</span> â€¢
                @endif
                <span x-text="currentTime">Loading...</span>
            </div>
        </div>

        <!-- Header Actions -->
        <div class="flex items-center space-x-3">
            <!-- Auto Refresh Toggle -->
            <flux:button 
                variant="ghost"
                size="sm"
                x-on:click="toggleAutoRefresh()"
                x-bind:class="autoRefresh ? 'text-green-600' : 'text-gray-500'"
            >
                <flux:icon.arrow-path x-bind:class="autoRefresh && 'animate-spin'" />
                <span x-text="autoRefresh ? 'Auto Refresh On' : 'Auto Refresh Off'">Auto Refresh Off</span>
            </flux:button>

            <!-- Export Dropdown -->
            <flux:dropdown position="bottom" align="end">
                <flux:button icon="arrow-down-tray" size="sm">
                    Export
                </flux:button>

                <flux:menu>
                    <flux:menu.item icon="document-text" x-on:click="exportData('json')">Export JSON</flux:menu.item>
                    <flux:menu.item icon="table-cells" x-on:click="exportData('csv')">Export CSV</flux:menu.item>
                    <flux:menu.item icon="document-arrow-down" x-on:click="exportData('excel')">Export Excel</flux:menu.item>
                </flux:menu>
            </flux:dropdown>
        </div>
    </div>

    <!-- Workflow Specific Content -->
    @php
        $currentWorkflow = $workflow ?? $workflowView ?? 'default';
    @endphp
    
    @if($currentWorkflow === 'urgent' && isset($workflowData))
        @include('dashboard.workflows.urgent', ['data' => $workflowData, 'kpis' => $kpis ?? [], 'alerts' => $alerts ?? []])
    @elseif($currentWorkflow === 'today' && isset($workflowData))
        @include('dashboard.workflows.today', ['data' => $workflowData, 'kpis' => $kpis ?? []])
    @elseif($currentWorkflow === 'scheduled' && isset($workflowData))
        @include('dashboard.workflows.scheduled', ['data' => $workflowData, 'kpis' => $kpis ?? []])
    @elseif($currentWorkflow === 'financial' && isset($workflowData))
        @include('dashboard.workflows.financial', ['data' => $workflowData, 'kpis' => $kpis ?? []])
    @elseif($currentWorkflow === 'reports' && isset($workflowData))
        @include('dashboard.workflows.reports', ['data' => $workflowData, 'kpis' => $kpis ?? []])
    @endif
    
    <!-- KPI Cards using Flux UI -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
        <!-- Total Revenue Card -->
        <flux:card class="bg-gradient-to-br from-green-500 to-emerald-600 text-white border-0">
            <div class="flex items-center justify-between">
                <div class="p-3 rounded-lg bg-white/10">
                    <flux:icon.currency-dollar class="size-6" />
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90">Total Revenue</div>
                    <div class="text-2xl font-bold" x-text="formatCurrency(kpis.monthly_revenue || 0)">$0</div>
                </div>
            </div>
            <div class="mt-4">
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-white/20 text-white border-0">
                    <svg class="size-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    Monthly
                </span>
            </div>
        </flux:card>

        <!-- Pending Invoices Card -->
        <flux:card class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white border-0">
            <div class="flex items-center justify-between">
                <div class="p-3 rounded-lg bg-white/10">
                    <flux:icon.document-text class="size-6" />
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90">Pending Invoices</div>
                    <div class="text-2xl font-bold" x-text="formatCurrency(kpis.pending_invoices_amount || 0)">$0</div>
                </div>
            </div>
            <div class="mt-4">
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-white/20 text-white border-0">
                    <flux:icon.clock class="size-3 mr-1" />
                    <span x-text="(kpis.pending_invoices_count || 0)">0</span> outstanding
                </span>
            </div>
        </flux:card>

        <!-- Active Clients Card -->
        <flux:card class="bg-gradient-to-br from-purple-500 to-pink-600 text-white border-0">
            <div class="flex items-center justify-between">
                <div class="p-3 rounded-lg bg-white/10">
                    <flux:icon.users class="size-6" />
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90">Active Clients</div>
                    <div class="text-2xl font-bold" x-text="kpis.total_clients || 0">0</div>
                </div>
            </div>
            <div class="mt-4">
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-white/20 text-white border-0">
                    <flux:icon.check-circle class="size-3 mr-1" />
                    Stable
                </span>
            </div>
        </flux:card>

        <!-- Open Tickets Card -->
        <flux:card class="bg-gradient-to-br from-orange-500 to-red-600 text-white border-0">
            <div class="flex items-center justify-between">
                <div class="p-3 rounded-lg bg-white/10">
                    <flux:icon.exclamation-triangle class="size-6" />
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90">Open Tickets</div>
                    <div class="text-2xl font-bold" x-text="kpis.open_tickets || 0">0</div>
                </div>
            </div>
            <div class="mt-4">
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-white/20 text-white border-0">
                    <flux:icon.exclamation-circle class="size-3 mr-1" />
                    <span x-text="kpis.overdue_invoices || 0">0</span> overdue
                </span>
            </div>
        </flux:card>
    </div>

    <!-- Charts Grid using Flux UI -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mt-8">
        <!-- Revenue Chart -->
        <flux:card>
            <div class="flex items-center justify-between mb-6">
                <div>
                    <flux:heading size="lg">Revenue Trends</flux:heading>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Monthly performance overview</p>
                </div>
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-green-500 text-white">Live Data</span>
            </div>
            <div class="h-80">
                @if(empty($revenueChartData['data']) || array_sum($revenueChartData['data'] ?? []) == 0)
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <flux:icon.chart-bar class="size-16 text-gray-400 mx-auto mb-4" />
                            <p class="text-gray-500">No revenue data yet</p>
                            <p class="text-sm text-gray-400 mt-1">Start creating invoices to see trends</p>
                        </div>
                    </div>
                @else
                    <canvas id="revenueChart" class="w-full h-full"></canvas>
                @endif
            </div>
        </flux:card>

        <!-- Support Overview Chart -->
        <flux:card>
            <div class="flex items-center justify-between mb-6">
                <div>
                    <flux:heading size="lg">Support Overview</flux:heading>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Ticket status distribution</p>
                </div>
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md bg-blue-500 text-white">Real-time</span>
            </div>
            <div class="h-80">
                @if(empty($ticketChartData['data']) || array_sum($ticketChartData['data'] ?? []) == 0)
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <flux:icon.chat-bubble-left-right class="size-16 text-gray-400 mx-auto mb-4" />
                            <p class="text-gray-500">No ticket data yet</p>
                            <p class="text-sm text-gray-400 mt-1">Tickets will appear here once created</p>
                        </div>
                    </div>
                @else
                    <canvas id="ticketsChart" class="w-full h-full"></canvas>
                @endif
            </div>
        </flux:card>
    </div>

    <!-- Quick Actions using Flux UI -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
        <flux:card class="bg-gradient-to-br from-green-500 to-emerald-600 text-white border-0 hover:scale-[1.02] transition-transform duration-200">
            <a href="{{ route('clients.create') }}" class="block">
                <div class="flex items-center mb-4">
                    <flux:icon.user-plus class="size-10" />
                </div>
                <flux:heading size="lg" class="text-white mb-2">Add New Client</flux:heading>
                <p class="text-green-100 text-sm mb-4">Create a new client profile and start managing their services</p>
                <div class="flex items-center text-sm font-medium">
                    <span>Get Started</span>
                    <flux:icon.arrow-right class="size-4 ml-2 group-hover:translate-x-1 transition-transform" />
                </div>
            </a>
        </flux:card>

        <flux:card class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white border-0 hover:scale-[1.02] transition-transform duration-200">
            <a href="{{ route('financial.invoices.create') }}" class="block">
                <div class="flex items-center mb-4">
                    <flux:icon.document-plus class="size-10" />
                </div>
                <flux:heading size="lg" class="text-white mb-2">Create Invoice</flux:heading>
                <p class="text-blue-100 text-sm mb-4">Generate professional invoices and track payments</p>
                <div class="flex items-center text-sm font-medium">
                    <span>Create Now</span>
                    <flux:icon.arrow-right class="size-4 ml-2 group-hover:translate-x-1 transition-transform" />
                </div>
            </a>
        </flux:card>

        <flux:card class="bg-gradient-to-br from-purple-500 to-pink-600 text-white border-0 hover:scale-[1.02] transition-transform duration-200">
            <a href="{{ route('reports.index') }}" class="block">
                <div class="flex items-center mb-4">
                    <flux:icon.chart-bar-square class="size-10" />
                </div>
                <flux:heading size="lg" class="text-white mb-2">View Reports</flux:heading>
                <p class="text-purple-100 text-sm mb-4">Access detailed analytics and business intelligence reports</p>
                <div class="flex items-center text-sm font-medium">
                    <span>Explore</span>
                    <flux:icon.arrow-right class="size-4 ml-2 group-hover:translate-x-1 transition-transform" />
                </div>
            </a>
        </flux:card>
    </div>

    <!-- Loading Overlay -->
    <div 
        x-show="loading" 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50"
    >
        <flux:card class="p-8 flex items-center space-x-4">
            <flux:icon.arrow-path class="size-8 animate-spin text-blue-500" />
            <span class="font-medium">Loading dashboard data...</span>
        </flux:card>
    </div>
</div>
@endsection

@push('scripts')
<script>
// Pass server-side data to the dashboard component
window.dashboardData = {
    stats: @json($stats ?? []),
    revenueChartData: @json($revenueChartData ?? []),
    ticketChartData: @json($ticketChartData ?? []),
    routes: {
        realtime: '{{ route('dashboard.realtime') }}',
        export: '{{ route('dashboard.export') }}'
    }
};
</script>
@endpush