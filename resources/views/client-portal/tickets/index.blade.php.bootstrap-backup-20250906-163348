@extends('client-portal.layouts.app')

@section('title', 'Support Tickets')

@section('content')
<div class="container mx-auto px-4">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Support Tickets</h1>
                <p class="text-gray-600 dark:text-gray-400">Manage your support requests and track their progress</p>
            </div>
            @php
                $permissions = $contact->portal_permissions ?? [];
            @endphp
            @if(in_array('can_create_tickets', $permissions))
            <div>
                <flux:button href="{{ route('client.tickets.create') ?? '#' }}" variant="primary">
                    <i class="fas fa-plus mr-2"></i>New Ticket
                </flux:button>
            </div>
            @endif
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
        <flux:card>
            <flux:card.body class="py-4">
                <div class="flex items-center">
                    <div class="flex-1 mr-2">
                        <div class="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase mb-1">
                            Total Tickets
                        </div>
                        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                            {{ $stats['total_tickets'] ?? 0 }}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-clipboard-list fa-2x text-gray-300 dark:text-gray-600"></i>
                    </div>
                </div>
            </flux:card.body>
        </flux:card>

        <flux:card>
            <flux:card.body class="py-4">
                <div class="flex items-center">
                    <div class="flex-1 mr-2">
                        <div class="text-xs font-bold text-red-600 dark:text-red-400 uppercase mb-1">
                            Open Tickets
                        </div>
                        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                            {{ $stats['open_tickets'] ?? 0 }}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-ticket-alt fa-2x text-gray-300 dark:text-gray-600"></i>
                    </div>
                </div>
            </flux:card.body>
        </flux:card>

        <flux:card>
            <flux:card.body class="py-4">
                <div class="flex items-center">
                    <div class="flex-1 mr-2">
                        <div class="text-xs font-bold text-green-600 dark:text-green-400 uppercase mb-1">
                            Resolved This Month
                        </div>
                        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                            {{ $stats['resolved_this_month'] ?? 0 }}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle fa-2x text-gray-300 dark:text-gray-600"></i>
                    </div>
                </div>
            </flux:card.body>
        </flux:card>

        <flux:card>
            <flux:card.body class="py-4">
                <div class="flex items-center">
                    <div class="flex-1 mr-2">
                        <div class="text-xs font-bold text-yellow-600 dark:text-yellow-400 uppercase mb-1">
                            Avg Response Time
                        </div>
                        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                            {{ $stats['avg_response_time'] ?? '< 1h' }}
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock fa-2x text-gray-300 dark:text-gray-600"></i>
                    </div>
                </div>
            </flux:card.body>
        </flux:card>
    </div>

    <!-- Filters -->
    <flux:card class="mb-6">
        <flux:card.body>
            <form method="GET" action="{{ route('client.tickets') }}" class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[200px]">
                    <flux:input 
                        type="text" 
                        name="search" 
                        value="{{ request('search') }}"
                        placeholder="Search tickets..."
                        icon="search" />
                </div>
                <div>
                    <flux:select name="status" onchange="this.form.submit()">
                        <option value="">All Status</option>
                        <option value="Open" {{ request('status') == 'Open' ? 'selected' : '' }}>Open</option>
                        <option value="Awaiting Customer" {{ request('status') == 'Awaiting Customer' ? 'selected' : '' }}>Awaiting Customer</option>
                        <option value="In Progress" {{ request('status') == 'In Progress' ? 'selected' : '' }}>In Progress</option>
                        <option value="Resolved" {{ request('status') == 'Resolved' ? 'selected' : '' }}>Resolved</option>
                        <option value="Closed" {{ request('status') == 'Closed' ? 'selected' : '' }}>Closed</option>
                    </flux:select>
                </div>
                <div>
                    <flux:select name="priority" onchange="this.form.submit()">
                        <option value="">All Priorities</option>
                        <option value="Critical" {{ request('priority') == 'Critical' ? 'selected' : '' }}>Critical</option>
                        <option value="High" {{ request('priority') == 'High' ? 'selected' : '' }}>High</option>
                        <option value="Medium" {{ request('priority') == 'Medium' ? 'selected' : '' }}>Medium</option>
                        <option value="Low" {{ request('priority') == 'Low' ? 'selected' : '' }}>Low</option>
                    </flux:select>
                </div>
                <div>
                    <flux:button type="submit" variant="primary">
                        <i class="fas fa-filter mr-2"></i>Filter
                    </flux:button>
                </div>
            </form>
        </flux:card.body>
    </flux:card>

    <!-- Tickets Table -->
    <flux:card>
        <flux:card.body class="p-0">
            @if($tickets->isEmpty())
                <div class="text-center py-12">
                    <i class="fas fa-ticket-alt text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No Tickets Found</h3>
                    <p class="text-gray-500 dark:text-gray-500 mb-4">You haven't submitted any support tickets yet.</p>
                    @if(in_array('can_create_tickets', $permissions))
                        <flux:button href="{{ route('client.tickets.create') }}" variant="primary">
                            <i class="fas fa-plus mr-2"></i>Create Your First Ticket
                        </flux:button>
                    @endif
                </div>
            @else
                <flux:table>
                    <flux:thead>
                        <flux:row>
                            <flux:cell heading>#</flux:cell>
                            <flux:cell heading>Subject</flux:cell>
                            <flux:cell heading>Status</flux:cell>
                            <flux:cell heading>Priority</flux:cell>
                            <flux:cell heading>Created</flux:cell>
                            <flux:cell heading>Last Updated</flux:cell>
                            <flux:cell heading>Actions</flux:cell>
                        </flux:row>
                    </flux:thead>
                    <flux:tbody>
                        @foreach($tickets as $ticket)
                        <flux:row>
                            <flux:cell>
                                <span class="font-mono text-sm">{{ $ticket->ticket_number ?? '#' . $ticket->id }}</span>
                            </flux:cell>
                            <flux:cell>
                                <div>
                                    <a href="{{ route('client.tickets.show', $ticket->id) }}" class="text-blue-600 hover:underline font-medium">
                                        {{ Str::limit($ticket->subject, 50) }}
                                    </a>
                                    @if($ticket->category)
                                        <span class="block text-xs text-gray-500">{{ ucfirst(str_replace('_', ' ', $ticket->category)) }}</span>
                                    @endif
                                </div>
                            </flux:cell>
                            <flux:cell>
                                @php
                                    $statusColors = [
                                        'Open' => 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                                        'Awaiting Customer' => 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                                        'In Progress' => 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                                        'Resolved' => 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                                        'Closed' => 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                                    ];
                                    $statusColor = $statusColors[$ticket->status] ?? 'bg-gray-100 text-gray-800';
                                @endphp
                                <flux:badge class="{{ $statusColor }}">{{ $ticket->status }}</flux:badge>
                            </flux:cell>
                            <flux:cell>
                                @php
                                    $priorityColors = [
                                        'Critical' => 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                                        'High' => 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
                                        'Medium' => 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                                        'Low' => 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
                                    ];
                                    $priorityColor = $priorityColors[$ticket->priority] ?? 'bg-gray-100 text-gray-800';
                                @endphp
                                <flux:badge class="{{ $priorityColor }}">{{ $ticket->priority }}</flux:badge>
                            </flux:cell>
                            <flux:cell>
                                <span class="text-sm text-gray-600 dark:text-gray-400">
                                    {{ $ticket->created_at->format('M j, Y') }}
                                </span>
                            </flux:cell>
                            <flux:cell>
                                <span class="text-sm text-gray-600 dark:text-gray-400">
                                    {{ $ticket->updated_at->diffForHumans() }}
                                </span>
                            </flux:cell>
                            <flux:cell>
                                <div class="flex gap-2">
                                    <flux:button size="sm" variant="ghost" href="{{ route('client.tickets.show', $ticket->id) }}">
                                        <i class="fas fa-eye"></i>
                                    </flux:button>
                                    @if(in_array($ticket->status, ['Open', 'Awaiting Customer', 'In Progress']))
                                        <flux:button size="sm" variant="ghost" href="{{ route('client.tickets.show', $ticket->id) }}#reply">
                                            <i class="fas fa-reply"></i>
                                        </flux:button>
                                    @endif
                                </div>
                            </flux:cell>
                        </flux:row>
                        @endforeach
                    </flux:tbody>
                </flux:table>

                <!-- Pagination -->
                <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                    {{ $tickets->links() }}
                </div>
            @endif
        </flux:card.body>
    </flux:card>
</div>
@endsection