@extends('layouts.app')

@section('content')
<div class="w-full px-6">
    <div class="flex flex-wrap -mx-4">
        <div class="flex-1 px-6-12">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="h3 mb-0">Warranty Details</h1>
                    <p class="text-gray-600 mb-0">View warranty information and coverage</p>
                </div>
                <div class="flex gap-2">
                    <a href="{{ route('assets.warranties.edit', $warranty ?? 1) }}" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-outline-primary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    @if(isset($warranty) && $warranty->status === 'active')
                        <button type="button" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-info" onclick="renewWarranty()">
                            <i class="fas fa-refresh"></i> Renew
                        </flux:button>
                    @endif
                    @if(isset($warranty) && in_array($warranty->status ?? 'active', ['active', 'expired']))
                        <button type="button" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-warning" onclick="markExpired()">
                            <i class="fas fa-exclamation-triangle"></i> Mark Expired
                        </flux:button>
                    @endif
                    <a href="{{ route('assets.warranties.index') }}" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>

            <div class="flex flex-wrap -mx-4">
                <div class="md:w-2/3 px-6">
                    <!-- Main Details -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="px-6 py-6 border-b border-gray-200 bg-gray-50">
                            <div class="flex justify-between items-center">
                                <h5 class="bg-white rounded-lg shadow-md overflow-hidden-title mb-0">{{ $warranty->warranty_number ?? 'WRN-123456789' }}</h5>
                                <div class="flex gap-2">
                                    @php
                                        $status = $warranty->status ?? 'active';
                                        $statusColors = [
                                            'active' => 'bg-success',
                                            'expired' => 'bg-danger',
                                            'inactive' => 'bg-secondary',
                                            'renewed' => 'bg-info'
                                        ];
                                    @endphp
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ $statusColors[$status] ?? 'bg-gray-600' }}">
                                        {{ ucfirst($status) }}
                                    </span>
                                    @php
                                        $type = $warranty->warranty_type ?? 'manufacturer';
                                        $typeColors = [
                                            'manufacturer' => 'bg-primary',
                                            'extended' => 'bg-info',
                                            'service' => 'bg-warning',
                                            'maintenance' => 'bg-secondary'
                                        ];
                                    @endphp
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ $typeColors[$type] ?? 'bg-gray-600' }}">
                                        {{ ucfirst($type) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap -mx-4 mb-6">
                                <div class="md:w-1/2 px-6">
                                    <strong>Asset:</strong>
                                    <div class="ml-3">
                                        {{ $warranty->asset->name ?? 'Sample Server' }}
                                        <br><small class="text-gray-600">{{ $warranty->asset->asset_tag ?? 'SRV-001' }}</small>
                                    </div>
                                </div>
                                <div class="flex-1 px-6-md-6">
                                    <strong>Warranty Provider:</strong>
                                    <div class="ml-3">{{ $warranty->provider_name ?? 'Dell Technologies' }}</div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <strong>Coverage Details:</strong>
                                <div class="ml-4 mt-1">
                                    <div class="bg-gray-100 p-6 rounded">
                                        {{ $warranty->coverage_details ?? 'Full hardware replacement including parts and labor, 24/7 support with 4-hour response time, on-site service included for critical failures.' }}
                                    </div>
                                </div>
                            </div>

                            @if(isset($warranty->terms_conditions) || true)
                                <div class="mb-6">
                                    <strong>Terms & Conditions:</strong>
                                    <div class="ml-4 mt-1">
                                        <div class="bg-gray-100 p-6 rounded">
                                            {{ $warranty->terms_conditions ?? 'Standard manufacturer warranty terms apply. Coverage excludes damage due to misuse, environmental factors, or unauthorized modifications.' }}
                                        </div>
                                    </div>
                                </div>
                            @endif

                            @if(isset($warranty->notes) || true)
                                <div class="mb-6">
                                    <strong>Notes:</strong>
                                    <div class="ml-4 mt-1">
                                        <div class="bg-light p-6 rounded">
                                            {{ $warranty->notes ?? 'Warranty registered and confirmed active. Keep proof of purchase for warranty claims.' }}
                                        </div>
                                    </div>
                                </div>
                            @endif
                        </div>
                    </div>

                    <!-- Warranty Period & Cost -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="px-6 py-6 border-b border-gray-200 bg-gray-50">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Warranty Period & Cost</h6>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-wrap -mx-4">
                                <div class="flex-1 px-6-md-6">
                                    <div class="mb-6">
                                        <strong>Start Date:</strong>
                                        <div class="ml-4">{{ ($warranty->warranty_start_date ?? now()->subMonths(6))->format('M d, Y') }}</div>
                                    </div>
                                    <div class="mb-6">
                                        <strong>End Date:</strong>
                                        <div class="ml-4">
                                            @php
                                                $endDate = $warranty->warranty_end_date ?? now()->addMonths(18);
                                                $daysRemaining = now()->diffInDays($endDate, false);
                                                $isExpiring = $daysRemaining <= 30 && $daysRemaining > 0;
                                                $isExpired = $daysRemaining < 0;
                                            @endphp
                                            {{ $endDate->format('M d, Y') }}
                                            @if($isExpired)
                                                <span class="text-red-600 ml-2">
                                                    <i class="fas fa-exclamation-triangle"></i> Expired
                                                </span>
                                            @elseif($isExpiring)
                                                <span class="text-yellow-600 dark:text-yellow-400 ml-2">
                                                    <i class="fas fa-clock"></i> Expires in {{ $daysRemaining }} days
                                                </span>
                                            @endif
                                        </div>
                                    </div>
                                    <div class="mb-6">
                                        <strong>Duration:</strong>
                                        <div class="ml-4">
                                            @php
                                                $startDate = $warranty->warranty_start_date ?? now()->subMonths(6);
                                                $totalDays = $startDate->diffInDays($endDate);
                                                $months = floor($totalDays / 30);
                                                $remainingDays = $totalDays % 30;
                                            @endphp
                                            {{ $months }} months
                                            @if($remainingDays > 0)
                                                , {{ $remainingDays }} days
                                            @endif
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-1 px-6-md-6">
                                    <div class="mb-6">
                                        <strong>Warranty Cost:</strong>
                                        <div class="ml-4">${{ number_format($warranty->cost ?? 299.99, 2) }}</div>
                                    </div>
                                    @if(isset($warranty->deductible))
                                        <div class="mb-6">
                                            <strong>Deductible:</strong>
                                            <div class="ml-4">${{ number_format($warranty->deductible ?? 0, 2) }}</div>
                                        </div>
                                    @endif
                                    <div class="mb-6">
                                        <strong>Auto-renewal:</strong>
                                        <div class="ml-4">
                                            @if($warranty->auto_renewal ?? false)
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success">Enabled</span>
                                            @else
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-secondary">Disabled</span>
                                            @endif
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Support Information -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Support Information</h6>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                            <div class="flex flex-wrap -mx-4">
                                <div class="flex-1 px-6-md-6">
                                    @if(isset($warranty->contact_name))
                                        <div class="mb-6">
                                            <strong>Contact Name:</strong>
                                            <div class="ml-4">{{ $warranty->contact_name }}</div>
                                        </div>
                                    @endif
                                    @if(isset($warranty->contact_phone) || true)
                                        <div class="mb-6">
                                            <strong>Support Phone:</strong>
                                            <div class="ml-4">
                                                <a href="tel:{{ $warranty->contact_phone ?? '+1-800-555-0199' }}" class="text-decoration-none">
                                                    {{ $warranty->contact_phone ?? '+1-800-555-0199' }}
                                                </a>
                                            </div>
                                        </div>
                                    @endif
                                </div>
                                <div class="flex-1 px-6-md-6">
                                    @if(isset($warranty->contact_email) || true)
                                        <div class="mb-6">
                                            <strong>Support Email:</strong>
                                            <div class="ml-4">
                                                <a href="mailto:{{ $warranty->contact_email ?? 'support@dell.com' }}" class="text-decoration-none">
                                                    {{ $warranty->contact_email ?? 'support@dell.com' }}
                                                </a>
                                            </div>
                                        </div>
                                    @endif
                                    @if(isset($warranty->support_url) || true)
                                        <div class="mb-6">
                                            <strong>Support Portal:</strong>
                                            <div class="ml-4">
                                                <a href="{{ $warranty->support_url ?? 'https://support.dell.com' }}" target="_blank" class="text-decoration-none">
                                                    {{ $warranty->support_url ?? 'https://support.dell.com' }}
                                                    <i class="fas fa-external-link-alt ml-1"></i>
                                                </a>
                                            </div>
                                        </div>
                                    @endif
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Warranty Claims History -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header">
                            <div class="flex justify-between items-center">
                                <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Warranty Claims</h6>
                                <button type="button" class="px-4 py-2 font-medium rounded-md transition-colors px-6 py-1 text-sm px-6 py-2 font-medium rounded-md transition-colors-outline-primary" onclick="addClaim()">
                                    <i class="fas fa-plus"></i> Add Claim
                                </flux:button>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                            @php
                                $claims = [
                                    ['date' => '2024-01-15', 'description' => 'Hard drive replacement', 'status' => 'completed', 'amount' => 150.00],
                                    ['date' => '2023-08-22', 'description' => 'Memory module replacement', 'status' => 'completed', 'amount' => 80.00],
                                ];
                            @endphp
                            @if(count($claims) > 0)
                                <div class="min-w-full divide-y divide-gray-200-responsive">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 min-w-full divide-y divide-gray-200-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Description</th>
                                                <th>Status</th>
                                                <th>Amount</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach($claims as $claim)
                                                <tr>
                                                    <td>{{ \Carbon\Carbon::parse($claim['date'])->format('M d, Y') }}</td>
                                                    <td>{{ $claim['description'] }}</td>
                                                    <td>
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success">{{ ucfirst($claim['status']) }}</span>
                                                    </td>
                                                    <td>${{ number_format($claim['amount'], 2) }}</td>
                                                    <td>
                                                        <button type="button" class="px-4 py-2 font-medium rounded-md transition-colors px-6 py-1 text-sm px-6 py-2 font-medium rounded-md transition-colors-outline-primary">
                                                            <i class="fas fa-eye"></i>
                                                        </flux:button>
                                                    </td>
                                                </tr>
                                            @endforeach
                                        </tbody>
                                    </table>
                                </div>
                            @else
                                <div class="text-center py-6">
                                    <i class="fas fa-clipboard-list fa-2x text-gray-600 dark:text-gray-400 mb-2"></i>
                                    <p class="text-gray-600 dark:text-gray-400">No warranty claims on record</p>
                                </div>
                            @endif
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="flex-1 px-6-md-4">
                    <!-- Asset Quick Info -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Asset Information</h6>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                            <div class="mb-2">
                                <strong>{{ $warranty->asset->name ?? 'Dell PowerEdge R740' }}</strong>
                                <br><small class="text-gray-600 dark:text-gray-400">{{ $warranty->asset->asset_tag ?? 'SRV-001' }}</small>
                            </div>
                            <div class="mb-2">
                                <small class="text-gray-600 dark:text-gray-400">Category:</small> {{ $warranty->asset->category ?? 'Server Hardware' }}
                            </div>
                            <div class="mb-2">
                                <small class="text-gray-600 dark:text-gray-400">Location:</small> {{ $warranty->asset->location ?? 'Data Center A - Rack 12' }}
                            </div>
                            <div class="mb-6">
                                <small class="text-gray-600 dark:text-gray-400">Serial:</small> {{ $warranty->asset->serial_number ?? 'DL740-XYZ123456' }}
                            </div>
                            <a href="{{ route('assets.show', $warranty->asset_id ?? 1) }}" class="px-4 py-2 font-medium rounded-md transition-colors px-6 py-1 text-sm px-6 py-2 font-medium rounded-md transition-colors-outline-primary">
                                <i class="fas fa-external-link-alt"></i> View Asset Details
                            </a>
                        </div>
                    </div>

                    <!-- Expiry Alert -->
                    @if($isExpiring || $isExpired)
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6 border-{{ $isExpired ? 'danger' : 'warning' }}">
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header bg-{{ $isExpired ? 'danger' : 'warning' }} text-white">
                                <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">
                                    <i class="fas fa-{{ $isExpired ? 'exclamation-triangle' : 'clock' }}"></i> 
                                    Warranty {{ $isExpired ? 'Expired' : 'Expiring' }}
                                </h6>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                                @if($isExpired)
                                    <p class="mb-2">This warranty expired {{ abs($daysRemaining) }} days ago.</p>
                                    <div class="grid">
                                        <button type="button" class="px-6 py-2 font-medium rounded-md transition-colors bg-cyan-600 text-white hover:bg-cyan-700 px-6 py-2 font-medium rounded-md transition-colors-sm" onclick="renewWarranty()">
                                            <i class="fas fa-refresh"></i> Renew Warranty
                                        </flux:button>
                                    </div>
                                @else
                                    <p class="mb-2">This warranty expires in {{ $daysRemaining }} days.</p>
                                    <div class="grid">
                                        <button type="button" class="px-6 py-2 font-medium rounded-md transition-colors bg-yellow-500 text-white hover:bg-yellow-600 px-6 py-2 font-medium rounded-md transition-colors-sm" onclick="renewWarranty()">
                                            <i class="fas fa-refresh"></i> Renew Early
                                        </flux:button>
                                    </div>
                                @endif
                            </div>
                        </div>
                    @endif

                    <!-- Other Warranties -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Other Asset Warranties</h6>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                            @php
                                $otherWarranties = [
                                    ['type' => 'Extended Service', 'expires' => '2025-12-31', 'status' => 'active'],
                                    ['type' => 'Software Support', 'expires' => '2024-06-30', 'status' => 'expired'],
                                ];
                            @endphp
                            @if(count($otherWarranties) > 0)
                                @foreach($otherWarranties as $other)
                                    <div class="flex justify-between items-center mb-2">
                                        <div>
                                            <div class="font-bold">{{ $other['type'] }}</div>
                                            <small class="text-gray-600 dark:text-gray-400">Expires: {{ \Carbon\Carbon::parse($other['expires'])->format('M d, Y') }}</small>
                                        </div>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-{{ $other['status'] === 'active' ? 'success' : 'danger' }}">
                                            {{ ucfirst($other['status']) }}
                                        </span>
                                    </div>
                                @endforeach
                            @else
                                <p class="text-gray-600 dark:text-gray-400 text-center">No other warranties</p>
                            @endif
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Quick Actions</h6>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                            <div class="grid gap-2">
                                <button type="button" class="px-6 py-2 font-medium rounded-md transition-colors border border-blue-600 text-blue-600 hover:bg-blue-50 px-6 py-2 font-medium rounded-md transition-colors-sm" onclick="contactSupport()">
                                    <i class="fas fa-phone"></i> Contact Support
                                </flux:button>
                                <button type="button" class="btn px-6 py-2 font-medium rounded-md transition-colors-outline-info px-6 py-2 font-medium rounded-md transition-colors-sm" onclick="downloadWarranty()">
                                    <i class="fas fa-download"></i> Download Certificate
                                </flux:button>
                                <button type="button" class="px-6 py-2 font-medium rounded-md transition-colors border border-green-600 text-green-600 hover:bg-green-50 px-6 py-2 font-medium rounded-md transition-colors-sm" onclick="addClaim()">
                                    <i class="fas fa-plus"></i> File Claim
                                </flux:button>
                                <button type="button" class="btn px-6 py-2 font-medium rounded-md transition-colors-outline-warning px-6 py-2 font-medium rounded-md transition-colors-sm" onclick="setReminder()">
                                    <i class="fas fa-bell"></i> Set Reminder
                                </flux:button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Modals -->
<div class="fixed inset-0 z-50 overflow-y-auto fade" id="actionModal" tabindex="-1">
    <div class="fixed inset-0 z-50 overflow-y-auto-dialog">
        <div class="fixed inset-0 z-50 overflow-y-auto-content">
            <div class="fixed inset-0 z-50 overflow-y-auto-header">
                <h5 class="fixed inset-0 z-50 overflow-y-auto-title" id="modalTitle">Confirm Action</h5>
                <button type="button" class="px-6 py-2 font-medium rounded-md transition-colors-close" @click="$dispatch('close-modal')"></flux:button>
            </div>
            <div class="fixed inset-0 z-50 overflow-y-auto-body" id="modalBody">
                <!-- Dynamic content -->
            </div>
            <div class="fixed inset-0 z-50 overflow-y-auto-footer">
                <button type="button" class="inline-flex items-center px-6 py-2 bg-gray-600 text-white font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" @click="$dispatch('close-modal')">Cancel</flux:button>
                <form id="actionForm" method="POST" style="display: inline;">
                    @csrf
                    @method('PATCH')
                    <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" id="confirmButton">Confirm</flux:button>
                </form>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script>
function showActionModal(title, message, action, buttonClass = 'btn-primary', buttonText = 'Confirm') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = message;
    document.getElementById('confirmButton').className = `btn ${buttonClass}`;
    document.getElementById('confirmButton').textContent = buttonText;
    
    const form = document.getElementById('actionForm');
    form.action = action;
    
    const modal = new bootstrap.Modal(document.getElementById('actionModal'));
    modal.show();
}

function renewWarranty() {
    showActionModal(
        'Renew Warranty',
        'Start the warranty renewal process for this asset?',
        '{{ route("assets.warranties.renew", $warranty ?? 1) }}',
        'btn-info',
        'Start Renewal'
    );
}

function markExpired() {
    showActionModal(
        'Mark Warranty Expired',
        'Are you sure you want to mark this warranty as expired?',
        '{{ route("assets.warranties.mark-expired", $warranty ?? 1) }}',
        'btn-warning',
        'Mark Expired'
    );
}

function contactSupport() {
    const phone = '{{ $warranty->contact_phone ?? "+1-800-555-0199" }}';
    window.open(`tel:${phone}`);
}

function downloadWarranty() {
    window.open('{{ route("assets.warranties.show", $warranty ?? 1) }}?format=pdf', '_blank');
}

function addClaim() {
    // In a real application, this would open a claim form or redirect to a claims module
    alert('Warranty claim form would open here. This would integrate with a claims management system.');
}

function setReminder() {
    // In a real application, this would open a reminder configuration modal
    alert('Reminder configuration would open here. This would integrate with the notification system.');
}
</script>
@endpush