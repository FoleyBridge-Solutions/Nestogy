@extends('layouts.app')

@section('content')
<div class="w-full px-6">
    <div class="flex flex-wrap -mx-4">
        <div class="flex-1 px-6-12">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="h3 mb-0">Schedule Maintenance</h1>
                    <p class="text-gray-600 mb-0">Create a new maintenance task for an asset</p>
                </div>
                <div>
                    <a href="{{ route('assets.maintenance.index') }}" class="btn px-6 py-2 font-medium rounded-md transition-colors-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>

            <div class="flex flex-wrap -mx-4">
                <div class="md:w-2/3 px-6">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="px-6 py-6 border-b border-gray-200 bg-gray-50">
                            <h5 class="bg-white rounded-lg shadow-md overflow-hidden-title mb-0">Maintenance Details</h5>
                        </div>
                        <div class="p-6">
                            <form action="{{ route('assets.maintenance.store') }}" method="POST" id="maintenanceForm">
                                @csrf

                                <!-- Asset Selection -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="md:w-1/2 px-6">
                                        <label for="asset_id" class="block text-sm font-medium text-gray-700 mb-1">Asset <span class="text-red-600">*</span></flux:label>
                                        <select name="asset_id" id="asset_id" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('asset_id') border-red-500 @enderror" required>
                                            <option value="">Select an asset...</option>
                                            @foreach($assets ?? [] as $asset)
                                                <option value="{{ $asset->id }}" {{ old('asset_id') == $asset->id ? 'selected' : '' }}>
                                                    {{ $asset->name }} ({{ $asset->asset_tag }})
                                                </option>
                                            @endforeach
                                        </flux:select>
                                        @error('asset_id')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-6">
                                        <label for="maintenance_type" class="block text-sm font-medium text-gray-700 mb-1">Maintenance Type <span class="text-red-600">*</span></flux:label>
                                        <select name="maintenance_type" id="maintenance_type" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('maintenance_type') border-red-500 @enderror" required>
                                            <option value="">Select type...</option>
                                            <option value="preventive" {{ old('maintenance_type') === 'preventive' ? 'selected' : '' }}>Preventive</option>
                                            <option value="corrective" {{ old('maintenance_type') === 'corrective' ? 'selected' : '' }}>Corrective</option>
                                            <option value="emergency" {{ old('maintenance_type') === 'emergency' ? 'selected' : '' }}>Emergency</option>
                                            <option value="routine" {{ old('maintenance_type') === 'routine' ? 'selected' : '' }}>Routine</option>
                                        </flux:select>
                                        @error('maintenance_type')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Title and Description -->
                                <div class="mb-6">
                                    <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title <span class="text-red-600 dark:text-red-400">*</span></flux:label>
                                    <input type="text" name="title" id="title" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('title') border-red-500 @enderror" 
                                           value="{{ old('title') }}" required placeholder="Brief description of maintenance task">
                                    @error('title')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <div class="mb-6">
                                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</flux:label>
                                    <textarea name="description" id="description" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('description') border-red-500 @enderror" 
                                              rows="4" placeholder="Detailed description of maintenance task...">{{ old('description') }}</flux:textarea>
                                    @error('description')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <!-- Scheduling -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="flex-1 px-6-md-6">
                                        <label for="scheduled_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Scheduled Date</flux:label>
                                        <input type="date" name="scheduled_date" id="scheduled_date" 
                                               class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('scheduled_date') border-red-500 @enderror" 
                                               value="{{ old('scheduled_date') }}">
                                        @error('scheduled_date')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-6">
                                        <label for="estimated_duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estimated Duration (hours)</flux:label>
                                        <input type="number" name="estimated_duration" id="estimated_duration" 
                                               class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('estimated_duration') border-red-500 @enderror" 
                                               value="{{ old('estimated_duration') }}" min="0.5" step="0.5" placeholder="2.0">
                                        @error('estimated_duration')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Priority and Assignment -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="flex-1 px-6-md-6">
                                        <label for="priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority <span class="text-red-600 dark:text-red-400">*</span></flux:label>
                                        <select name="priority" id="priority" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('priority') border-red-500 @enderror" required>
                                            <option value="">Select priority...</option>
                                            <option value="low" {{ old('priority') === 'low' ? 'selected' : '' }}>Low</option>
                                            <option value="medium" {{ old('priority') === 'medium' ? 'selected' : '' }}>Medium</option>
                                            <option value="high" {{ old('priority') === 'high' ? 'selected' : '' }}>High</option>
                                            <option value="critical" {{ old('priority') === 'critical' ? 'selected' : '' }}>Critical</option>
                                        </flux:select>
                                        @error('priority')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-6">
                                        <label for="assigned_to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assign To</flux:label>
                                        <select name="assigned_to" id="assigned_to" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('assigned_to') border-red-500 @enderror">
                                            <option value="">Unassigned</option>
                                            @foreach($technicians ?? [] as $user)
                                                <option value="{{ $user->id }}" {{ old('assigned_to') == $user->id ? 'selected' : '' }}>
                                                    {{ $user->name }}
                                                </option>
                                            @endforeach
                                        </flux:select>
                                        @error('assigned_to')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Cost and Recurring -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="flex-1 px-6-md-6">
                                        <label for="estimated_cost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estimated Cost</flux:label>
                                        <div class="flex">
                                            <span class="flex-text">$</span>
                                            <input type="number" name="estimated_cost" id="estimated_cost" 
                                                   class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('estimated_cost') border-red-500 @enderror" 
                                                   value="{{ old('estimated_cost') }}" min="0" step="0.01" placeholder="0.00">
                                        </div>
                                        @error('estimated_cost')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-6">
                                        <label for="recurring_interval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recurring Interval</flux:label>
                                        <select name="recurring_interval" id="recurring_interval" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('recurring_interval') border-red-500 @enderror">
                                            <option value="">One-time maintenance</option>
                                            <option value="weekly" {{ old('recurring_interval') === 'weekly' ? 'selected' : '' }}>Weekly</option>
                                            <option value="monthly" {{ old('recurring_interval') === 'monthly' ? 'selected' : '' }}>Monthly</option>
                                            <option value="quarterly" {{ old('recurring_interval') === 'quarterly' ? 'selected' : '' }}>Quarterly</option>
                                            <option value="semi_annually" {{ old('recurring_interval') === 'semi_annually' ? 'selected' : '' }}>Semi-Annually</option>
                                            <option value="annually" {{ old('recurring_interval') === 'annually' ? 'selected' : '' }}>Annually</option>
                                        </flux:select>
                                        @error('recurring_interval')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Instructions and Notes -->
                                <div class="mb-6">
                                    <label for="instructions" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Instructions</flux:label>
                                    <textarea name="instructions" id="instructions" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('instructions') border-red-500 @enderror" 
                                              rows="3" placeholder="Step-by-step instructions for performing this maintenance...">{{ old('instructions') }}</flux:textarea>
                                    @error('instructions')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <div class="mb-6">
                                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</flux:label>
                                    <textarea name="notes" id="notes" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('notes') border-red-500 @enderror" 
                                              rows="3" placeholder="Additional notes or comments...">{{ old('notes') }}</flux:textarea>
                                    @error('notes')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <!-- Submit Buttons -->
                                <div class="flex gap-2">
                                    <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-save"></i> Schedule Maintenance
                                    </flux:button>
                                    <button type="submit" name="status" value="in_progress" class="inline-flex items-center px-6 py-2 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                        <i class="fas fa-play"></i> Schedule & Start
                                    </flux:button>
                                    <a href="{{ route('assets.maintenance.index') }}" class="btn px-6 py-2 font-medium rounded-md transition-colors-outline-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Info -->
                <div class="flex-1 px-6-md-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
                        <div class="px-6 py-6 border-b border-gray-200 bg-gray-50">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Maintenance Guidelines</h6>
                        </div>
                        <div class="p-6">
                            <div class="mb-6">
                                <h6 class="text-blue-600">Maintenance Types</h6>
                                <small class="text-gray-600">
                                    <strong>Preventive:</strong> Scheduled regular maintenance<br>
                                    <strong>Corrective:</strong> Fix identified issues<br>
                                    <strong>Emergency:</strong> Urgent unscheduled repairs<br>
                                    <strong>Routine:</strong> Regular operational checks
                                </small>
                            </div>
                            
                            <div class="mb-6">
                                <h6 class="text-yellow-600 dark:text-yellow-400">Priority Levels</h6>
                                <small class="text-gray-600 dark:text-gray-400">
                                    <strong>Critical:</strong> Immediate attention required<br>
                                    <strong>High:</strong> Complete within 24 hours<br>
                                    <strong>Medium:</strong> Complete within a week<br>
                                    <strong>Low:</strong> Complete when convenient
                                </small>
                            </div>

                            <div class="px-6 py-6 rounded bg-cyan-100 border border-cyan-400 text-cyan-700">
                                <h6 class="px-6 py-6 rounded mb-6-heading">ðŸ’¡ Pro Tips</h6>
                                <small>
                                    â€¢ Set realistic time estimates<br>
                                    â€¢ Include detailed instructions<br>
                                    â€¢ Consider parts availability<br>
                                    â€¢ Schedule during low usage periods
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Asset Info (populated via JavaScript when asset is selected) -->
                    <div id="assetInfo" class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mt-6" style="display: none;">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Asset Information</h6>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                            <div id="assetDetails">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script>
document.addEventListener('DOMContentLoaded', function() {
    const assetSelect = document.getElementById('asset_id');
    const assetInfoCard = document.getElementById('assetInfo');
    const assetDetails = document.getElementById('assetDetails');
    
    // Asset selection change handler
    assetSelect.addEventListener('change', function() {
        const assetId = this.value;
        
        if (assetId) {
            // Show loading state
            assetInfoCard.style.display = 'block';
            assetDetails.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            // In a real application, you would fetch asset details via AJAX
            // For now, we'll show the selected asset info
            const selectedOption = this.options[this.selectedIndex];
            assetDetails.innerHTML = `
                <div class="mb-2">
                    <strong>Asset:</strong> ${selectedOption.text}
                </div>
                <div class="mb-2">
                    <small class="text-gray-600 dark:text-gray-400">Last maintenance details would be loaded here via API call</small>
                </div>
            `;
        } else {
            assetInfoCard.style.display = 'none';
        }
    });
    
    // Form validation
    const form = document.getElementById('maintenanceForm');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Check required fields
        const requiredFields = ['asset_id', 'maintenance_type', 'title', 'priority'];
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
        }
    });
    
    // Auto-populate title based on maintenance type and asset
    const maintenanceTypeSelect = document.getElementById('maintenance_type');
    maintenanceTypeSelect.addEventListener('change', function() {
        const titleField = document.getElementById('title');
        const assetOption = assetSelect.options[assetSelect.selectedIndex];
        
        if (this.value && assetSelect.value && !titleField.value) {
            const assetName = assetOption.text.split(' (')[0];
            const typeText = this.options[this.selectedIndex].text;
            titleField.value = `${typeText} maintenance for ${assetName}`;
        }
    });
});
</script>
@endpush