@extends('layouts.app')

@section('content')
<div class="w-full px-6">
    <div class="flex flex-wrap -mx-4">
        <div class="flex-1 px-6-12">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="h3 mb-0">Edit Maintenance</h1>
                    <p class="text-gray-600 mb-0">Update maintenance task details</p>
                </div>
                <div>
                    <a href="{{ route('assets.maintenance.show', $maintenance ?? 1) }}" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-outline-info">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                    <a href="{{ route('assets.maintenance.index') }}" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>

            <div class="flex flex-wrap -mx-4">
                <div class="md:w-2/3 px-6">
                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="px-6 py-6 border-b border-gray-200 bg-gray-50">
                            <div class="flex justify-between items-center">
                                <h5 class="bg-white rounded-lg shadow-md overflow-hidden-title mb-0">Maintenance Details</h5>
                                <div class="flex gap-2">
                                    @php
                                        $status = $maintenance->status ?? 'scheduled';
                                        $statusColors = [
                                            'scheduled' => 'bg-primary',
                                            'in_progress' => 'bg-info',
                                            'completed' => 'bg-success',
                                            'cancelled' => 'bg-secondary'
                                        ];
                                    @endphp
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ $statusColors[$status] ?? 'bg-gray-600' }}">
                                        {{ ucfirst(str_replace('_', ' ', $status)) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <form action="{{ route('assets.maintenance.update', $maintenance ?? 1) }}" method="POST" id="maintenanceForm">
                                @csrf
                                @method('PUT')

                                <!-- Asset Selection -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="md:w-1/2 px-6">
                                        <label for="asset_id" class="block text-sm font-medium text-gray-700 mb-1">Asset <span class="text-red-600">*</span></flux:label>
                                        <select name="asset_id" id="asset_id" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('asset_id') border-red-500 @enderror" required>
                                            <option value="">Select an asset...</option>
                                            @foreach($assets ?? [] as $asset)
                                                <option value="{{ $asset->id }}" 
                                                    {{ (old('asset_id', $maintenance->asset_id ?? '') == $asset->id) ? 'selected' : '' }}>
                                                    {{ $asset->name }} ({{ $asset->asset_tag }})
                                                </option>
                                            @endforeach
                                        </flux:select>
                                        @error('asset_id')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-6">
                                        <label for="maintenance_type" class="block text-sm font-medium text-gray-700 mb-1">Maintenance Type <span class="text-red-600">*</span></flux:label>
                                        <select name="maintenance_type" id="maintenance_type" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('maintenance_type') border-red-500 @enderror" required>
                                            <option value="">Select type...</option>
                                            <option value="preventive" {{ old('maintenance_type', $maintenance->maintenance_type ?? '') === 'preventive' ? 'selected' : '' }}>Preventive</option>
                                            <option value="corrective" {{ old('maintenance_type', $maintenance->maintenance_type ?? '') === 'corrective' ? 'selected' : '' }}>Corrective</option>
                                            <option value="emergency" {{ old('maintenance_type', $maintenance->maintenance_type ?? '') === 'emergency' ? 'selected' : '' }}>Emergency</option>
                                            <option value="routine" {{ old('maintenance_type', $maintenance->maintenance_type ?? '') === 'routine' ? 'selected' : '' }}>Routine</option>
                                        </flux:select>
                                        @error('maintenance_type')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Title and Description -->
                                <div class="mb-6">
                                    <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title <span class="text-red-600 dark:text-red-400">*</span></flux:label>
                                    <input type="text" name="title" id="title" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('title') border-red-500 @enderror" 
                                           value="{{ old('title', $maintenance->title ?? 'Preventive maintenance for Sample Asset') }}" required 
                                           placeholder="Brief description of maintenance task">
                                    @error('title')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <div class="mb-6">
                                    <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</flux:label>
                                    <textarea name="description" id="description" class="block w-full px-6 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('description') border-red-500 @enderror" 
                                              rows="4" placeholder="Detailed description of maintenance task...">{{ old('description', $maintenance->description ?? 'Regular preventive maintenance to ensure optimal performance and prevent unexpected failures.') }}</flux:textarea>
                                    @error('description')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <!-- Scheduling -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="flex-1 px-6-md-6">
                                        <label for="scheduled_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Scheduled Date</flux:label>
                                        <input type="date" name="scheduled_date" id="scheduled_date" 
                                               class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('scheduled_date') border-red-500 @enderror" 
                                               value="{{ old('scheduled_date', isset($maintenance->scheduled_date) ? $maintenance->scheduled_date->format('Y-m-d') : now()->addDays(7)->format('Y-m-d')) }}">
                                        @error('scheduled_date')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-6">
                                        <label for="estimated_duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estimated Duration (hours)</flux:label>
                                        <input type="number" name="estimated_duration" id="estimated_duration" 
                                               class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('estimated_duration') border-red-500 @enderror" 
                                               value="{{ old('estimated_duration', $maintenance->estimated_duration ?? '2.0') }}" 
                                               min="0.5" step="0.5" placeholder="2.0">
                                        @error('estimated_duration')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Status and Priority -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="flex-1 px-6-md-4">
                                        <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</flux:label>
                                        <select name="status" id="status" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('status') border-red-500 @enderror">
                                            <option value="scheduled" {{ old('status', $maintenance->status ?? 'scheduled') === 'scheduled' ? 'selected' : '' }}>Scheduled</option>
                                            <option value="in_progress" {{ old('status', $maintenance->status ?? '') === 'in_progress' ? 'selected' : '' }}>In Progress</option>
                                            <option value="completed" {{ old('status', $maintenance->status ?? '') === 'completed' ? 'selected' : '' }}>Completed</option>
                                            <option value="cancelled" {{ old('status', $maintenance->status ?? '') === 'cancelled' ? 'selected' : '' }}>Cancelled</option>
                                        </flux:select>
                                        @error('status')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-4">
                                        <label for="priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority <span class="text-red-600 dark:text-red-400">*</span></flux:label>
                                        <select name="priority" id="priority" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('priority') border-red-500 @enderror" required>
                                            <option value="">Select priority...</option>
                                            <option value="low" {{ old('priority', $maintenance->priority ?? 'medium') === 'low' ? 'selected' : '' }}>Low</option>
                                            <option value="medium" {{ old('priority', $maintenance->priority ?? 'medium') === 'medium' ? 'selected' : '' }}>Medium</option>
                                            <option value="high" {{ old('priority', $maintenance->priority ?? 'medium') === 'high' ? 'selected' : '' }}>High</option>
                                            <option value="critical" {{ old('priority', $maintenance->priority ?? 'medium') === 'critical' ? 'selected' : '' }}>Critical</option>
                                        </flux:select>
                                        @error('priority')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-4">
                                        <label for="assigned_to" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Assign To</flux:label>
                                        <select name="assigned_to" id="assigned_to" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('assigned_to') border-red-500 @enderror">
                                            <option value="">Unassigned</option>
                                            @foreach($technicians ?? [] as $user)
                                                <option value="{{ $user->id }}" {{ old('assigned_to', $maintenance->assigned_to ?? '') == $user->id ? 'selected' : '' }}>
                                                    {{ $user->name }}
                                                </option>
                                            @endforeach
                                        </flux:select>
                                        @error('assigned_to')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Cost and Recurring -->
                                <div class="flex flex-wrap -mx-4 mb-6">
                                    <div class="flex-1 px-6-md-6">
                                        <label for="estimated_cost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estimated Cost</flux:label>
                                        <div class="flex">
                                            <span class="flex-text">$</span>
                                            <input type="number" name="estimated_cost" id="estimated_cost" 
                                                   class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('estimated_cost') border-red-500 @enderror" 
                                                   value="{{ old('estimated_cost', $maintenance->estimated_cost ?? '150.00') }}" 
                                                   min="0" step="0.01" placeholder="0.00">
                                        </div>
                                        @error('estimated_cost')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                    <div class="flex-1 px-6-md-6">
                                        <label for="recurring_interval" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recurring Interval</flux:label>
                                        <select name="recurring_interval" id="recurring_interval" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('recurring_interval') border-red-500 @enderror">
                                            <option value="">One-time maintenance</option>
                                            <option value="weekly" {{ old('recurring_interval', $maintenance->recurring_interval ?? '') === 'weekly' ? 'selected' : '' }}>Weekly</option>
                                            <option value="monthly" {{ old('recurring_interval', $maintenance->recurring_interval ?? '') === 'monthly' ? 'selected' : '' }}>Monthly</option>
                                            <option value="quarterly" {{ old('recurring_interval', $maintenance->recurring_interval ?? '') === 'quarterly' ? 'selected' : '' }}>Quarterly</option>
                                            <option value="semi_annually" {{ old('recurring_interval', $maintenance->recurring_interval ?? '') === 'semi_annually' ? 'selected' : '' }}>Semi-Annually</option>
                                            <option value="annually" {{ old('recurring_interval', $maintenance->recurring_interval ?? '') === 'annually' ? 'selected' : '' }}>Annually</option>
                                        </flux:select>
                                        @error('recurring_interval')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Completion Details (if completed) -->
                                <div id="completionSection" style="{{ old('status', $maintenance->status ?? '') === 'completed' ? '' : 'display: none;' }}">
                                    <h6 class="text-green-600 mb-6">
                                        <i class="fas fa-check-circle"></i> Completion Details
                                    </h6>
                                    
                                    <div class="flex flex-wrap -mx-4 mb-6">
                                        <div class="flex-1 px-6-md-6">
                                            <label for="completed_at" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Completion Date</flux:label>
                                            <input type="datetime-local" name="completed_at" id="completed_at" 
                                                   class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('completed_at') border-red-500 @enderror" 
                                                   value="{{ old('completed_at', isset($maintenance->completed_at) ? $maintenance->completed_at->format('Y-m-d\TH:i') : now()->format('Y-m-d\TH:i')) }}">
                                            @error('completed_at')
                                                <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <div class="flex-1 px-6-md-6">
                                            <label for="actual_duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Actual Duration (hours)</flux:label>
                                            <input type="number" name="actual_duration" id="actual_duration" 
                                                   class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('actual_duration') border-red-500 @enderror" 
                                                   value="{{ old('actual_duration', $maintenance->actual_duration ?? '') }}" 
                                                   min="0.1" step="0.1" placeholder="2.5">
                                            @error('actual_duration')
                                                <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                            @enderror
                                        </div>
                                    </div>

                                    <div class="flex flex-wrap -mx-4 mb-6">
                                        <div class="flex-1 px-6-md-6">
                                            <label for="actual_cost" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Actual Cost</flux:label>
                                            <div class="flex">
                                                <span class="flex-text">$</span>
                                                <input type="number" name="actual_cost" id="actual_cost" 
                                                       class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('actual_cost') border-red-500 @enderror" 
                                                       value="{{ old('actual_cost', $maintenance->actual_cost ?? '') }}" 
                                                       min="0" step="0.01" placeholder="0.00">
                                            </div>
                                            @error('actual_cost')
                                                <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <div class="flex-1 px-6-md-6">
                                            <label for="completed_by" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Completed By</flux:label>
                                            <select name="completed_by" id="completed_by" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('completed_by') border-red-500 @enderror">
                                                <option value="">Select technician...</option>
                                                @foreach($technicians ?? [] as $user)
                                                    <option value="{{ $user->id }}" {{ old('completed_by', $maintenance->completed_by ?? auth()->id()) == $user->id ? 'selected' : '' }}>
                                                        {{ $user->name }}
                                                    </option>
                                                @endforeach
                                            </flux:select>
                                            @error('completed_by')
                                                <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                            @enderror
                                        </div>
                                    </div>

                                    <div class="mb-6">
                                        <label for="completion_notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Completion Notes</flux:label>
                                        <textarea name="completion_notes" id="completion_notes" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('completion_notes') border-red-500 @enderror" 
                                                  rows="3" placeholder="Notes about the completed maintenance...">{{ old('completion_notes', $maintenance->completion_notes ?? '') }}</flux:textarea>
                                        @error('completion_notes')
                                            <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                        @enderror
                                    </div>
                                </div>

                                <!-- Instructions and Notes -->
                                <div class="mb-6">
                                    <label for="instructions" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maintenance Instructions</flux:label>
                                    <textarea name="instructions" id="instructions" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('instructions') border-red-500 @enderror" 
                                              rows="3" placeholder="Step-by-step instructions for performing this maintenance...">{{ old('instructions', $maintenance->instructions ?? "1. Power down the asset safely\n2. Perform visual inspection\n3. Clean components\n4. Check connections\n5. Test functionality\n6. Document findings") }}</flux:textarea>
                                    @error('instructions')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <div class="mb-6">
                                    <label for="notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</flux:label>
                                    <textarea name="notes" id="notes" class="block w-full px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm @error('notes') border-red-500 @enderror" 
                                              rows="3" placeholder="Additional notes or comments...">{{ old('notes', $maintenance->notes ?? '') }}</flux:textarea>
                                    @error('notes')
                                        <div class="text-red-600 text-sm mt-1">{{ $message }}</div>
                                    @enderror
                                </div>

                                <!-- Submit Buttons -->
                                <div class="flex gap-2">
                                    <button type="submit" class="inline-flex items-center px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-save"></i> Update Maintenance
                                    </flux:button>
                                    @if($status !== 'completed')
                                        <button type="submit" name="quick_complete" value="1" class="inline-flex items-center px-6 py-2 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                            <i class="fas fa-check"></i> Save & Complete
                                        </flux:button>
                                    @endif
                                    <a href="{{ route('assets.maintenance.show', $maintenance ?? 1) }}" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-outline-info">
                                        <i class="fas fa-eye"></i> View Details
                                    </a>
                                    <a href="{{ route('assets.maintenance.index') }}" class="px-6 py-2 font-medium rounded-md transition-colors px-6 py-2 font-medium rounded-md transition-colors-outline-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Info -->
                <div class="flex-1 px-6-md-4">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="px-6 py-6 border-b border-gray-200 bg-gray-50">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Maintenance Status</h6>
                        </div>
                        <div class="p-6">
                            <div class="mb-6">
                                <strong>Current Status:</strong>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ $statusColors[$status] ?? 'bg-gray-600' }} ml-2">
                                    {{ ucfirst(str_replace('_', ' ', $status)) }}
                                </span>
                            </div>
                            @if(isset($maintenance->created_at))
                                <div class="mb-2">
                                    <strong>Created:</strong> {{ $maintenance->created_at->format('M d, Y g:i A') }}
                                </div>
                            @endif
                            @if(isset($maintenance->updated_at))
                                <div class="mb-2">
                                    <strong>Last Updated:</strong> {{ $maintenance->updated_at->format('M d, Y g:i A') }}
                                </div>
                            @endif
                        </div>
                    </div>

                    <!-- Asset Info -->
                    <div id="assetInfo" class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden" style="{{ old('asset_id', $maintenance->asset_id ?? '') ? '' : 'display: none;' }}">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-header">
                            <h6 class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-title mb-0">Asset Information</h6>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden-body">
                            <div id="assetDetails">
                                @if(isset($maintenance->asset))
                                    <div class="mb-2">
                                        <strong>{{ $maintenance->asset->name }}</strong>
                                        <br><small class="text-gray-600">{{ $maintenance->asset->asset_tag }}</small>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-gray-600 dark:text-gray-400">Category:</small> {{ $maintenance->asset->category }}
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-gray-600 dark:text-gray-400">Location:</small> {{ $maintenance->asset->location }}
                                    </div>
                                @endif
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@push('scripts')
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('status');
    const completionSection = document.getElementById('completionSection');
    
    // Status change handler
    statusSelect.addEventListener('change', function() {
        if (this.value === 'completed') {
            completionSection.style.display = 'block';
            document.getElementById('completed_at').required = true;
        } else {
            completionSection.style.display = 'none';
            document.getElementById('completed_at').required = false;
        }
    });
    
    // Form validation
    const form = document.getElementById('maintenanceForm');
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Check required fields
        const requiredFields = ['asset_id', 'maintenance_type', 'title', 'priority'];
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (!field.value.trim()) {
                field.classList.add('border-red-500');
                isValid = false;
            } else {
                field.classList.remove('border-red-500');
            }
        });
        
        // Check completion fields if status is completed
        if (statusSelect.value === 'completed') {
            const completedAt = document.getElementById('completed_at');
            if (!completedAt.value) {
                completedAt.classList.add('border-red-500');
                isValid = false;
            } else {
                completedAt.classList.remove('border-red-500');
            }
        }
        
        if (!isValid) {
            e.preventDefault();
            alert('Please fill in all required fields.');
        }
    });

    // Quick complete button handler
    const quickCompleteBtn = document.querySelector('button[name="quick_complete"]');
    if (quickCompleteBtn) {
        quickCompleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Set status to completed
            statusSelect.value = 'completed';
            statusSelect.dispatchEvent(new Event('change'));
            
            // Set completion date to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('completed_at').value = now.toISOString().slice(0, 16);
            
            // Set completed by to current user if not set
            const completedBy = document.getElementById('completed_by');
            if (!completedBy.value) {
                const assignedTo = document.getElementById('assigned_to').value;
                if (assignedTo) {
                    completedBy.value = assignedTo;
                }
            }
            
            // Submit the form
            form.submit();
        });
    }
});
</script>
@endpush