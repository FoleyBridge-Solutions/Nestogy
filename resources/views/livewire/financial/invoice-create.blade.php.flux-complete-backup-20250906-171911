<div>
    {{-- Progress Steps --}}
    <div class="mb-8">
        <nav aria-label="Progress">
            <ol class="flex items-center justify-between">
                @foreach($steps as $key => $label)
                    @php
                        $stepKeys = array_keys($steps);
                        $currentIndex = array_search($currentStep, $stepKeys);
                        $stepIndex = array_search($key, $stepKeys);
                        $isCompleted = $stepIndex < $currentIndex;
                        $isCurrent = $key === $currentStep;
                    @endphp
                    
                    <li class="relative flex-1 {{ !$loop->last ? 'pr-8 sm:pr-20' : '' }}">
                        <div class="flex items-center cursor-pointer" wire:click="goToStep('{{ $key }}')">
                            <div class="relative flex h-10 w-10 items-center justify-center rounded-full
                               {{ $isCompleted ? 'bg-green-600' : ($isCurrent ? 'bg-blue-600' : 'bg-gray-300') }}">
                                @if($isCompleted)
                                    <flux:icon name="check" class="h-5 w-5 text-white" />
                                @else
                                    <span class="text-white">{{ $loop->iteration }}</span>
                                @endif
                            </div>
                            <span class="ml-3 text-sm font-medium {{ $isCurrent ? 'text-blue-600' : 'text-gray-500' }}">
                                {{ $label }}
                            </span>
                        </div>
                        @if(!$loop->last)
                            <div class="absolute top-5 left-10 -ml-px h-0.5 w-full {{ $isCompleted ? 'bg-green-600' : 'bg-gray-300' }}"></div>
                        @endif
                    </li>
                @endforeach
            </ol>
        </nav>
    </div>

    {{-- Step Content --}}
    <flux:card>
        {{-- Step 1: Invoice Details --}}
        <div x-show="@js($currentStep) === 'details'" x-transition>
            <flux:heading size="lg" class="mb-6">Invoice Details</flux:heading>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <flux:select wire:model.live="client_id" label="Client" required>
                    <flux:select.option value="">Select a client...</flux:select.option>
                    @foreach($this->clients as $client)
                        <flux:select.option value="{{ $client->id }}">
                            {{ $client->name }}
                            @if($client->company_name)
                                ({{ $client->company_name }})
                            @endif
                        </flux:select.option>
                    @endforeach
                </flux:select>
                
                <flux:select wire:model="category_id" label="Category" required>
                    <flux:select.option value="">Select a category...</flux:select.option>
                    @foreach($this->categories as $category)
                        <flux:select.option value="{{ $category->id }}">
                            {{ $category->name }}
                        </flux:select.option>
                    @endforeach
                </flux:select>

                <flux:input 
                    type="date" 
                    wire:model="invoice_date" 
                    label="Invoice Date" 
                    required 
                />

                <flux:input 
                    type="date" 
                    wire:model="due_date" 
                    label="Due Date" 
                    required 
                />

                <flux:input.group>
                    <flux:input.group.prefix>{{ $prefix }}</flux:input.group.prefix>
                    <flux:input 
                        wire:model="number" 
                        label="Invoice Number" 
                        readonly
                    />
                </flux:input.group>

                <flux:select wire:model="currency_code" label="Currency">
                    <flux:select.option value="USD">USD - US Dollar</flux:select.option>
                    <flux:select.option value="EUR">EUR - Euro</flux:select.option>
                    <flux:select.option value="GBP">GBP - British Pound</flux:select.option>
                    <flux:select.option value="CAD">CAD - Canadian Dollar</flux:select.option>
                </flux:select>

                <div class="md:col-span-2">
                    <flux:textarea 
                        wire:model="scope" 
                        label="Description / Scope" 
                        rows="3"
                        placeholder="Brief description of the invoice..."
                    />
                </div>
            </div>
        </div>

        {{-- Step 2: Products & Services --}}
        <div x-show="@js($currentStep) === 'items'" x-transition>
            <div class="flex justify-between items-center mb-6">
                <flux:heading size="lg">Products & Services</flux:heading>
                <div class="flex gap-2">
                    <flux:button 
                        variant="primary" 
                        icon="plus"
                        wire:click="$set('showProductSelector', true)"
                    >
                        Add Product
                    </flux:button>
                    <flux:button 
                        variant="outline" 
                        icon="plus"
                        wire:click="$set('showCustomItemForm', true)"
                    >
                        Add Custom Item
                    </flux:button>
                </div>
            </div>

            {{-- Items Table --}}
            @if(count($items) > 0)
                <flux:table>
                    <flux:table.columns>
                        <flux:table.column>Item</flux:table.column>
                        <flux:table.column>Quantity</flux:table.column>
                        <flux:table.column>Unit Price</flux:table.column>
                        <flux:table.column>Tax</flux:table.column>
                        <flux:table.column>Subtotal</flux:table.column>
                        <flux:table.column>Actions</flux:table.column>
                    </flux:table.columns>
                    <flux:table.rows>
                        @foreach($items as $index => $item)
                            <flux:table.flex flex-wrap :key="$index">
                                <flux:table.cell>
                                    <div>
                                        <flux:text variant="strong">{{ $item['name'] }}</flux:text>
                                        @if(isset($item['description']) && $item['description'])
                                            <flux:text size="sm" variant="muted" class="block">
                                                {{ Str::limit($item['description'], 50) }}
                                            </flux:text>
                                        @endif
                                    </div>
                                </flux:table.cell>
                                <flux:table.cell>
                                    <flux:input 
                                        type="number" 
                                        wire:model.lazy="items.{{ $index }}.quantity"
                                        min="0.01" 
                                        step="0.01"
                                        class="w-20"
                                    />
                                </flux:table.cell>
                                <flux:table.cell>
                                    <flux:input 
                                        type="number" 
                                        wire:model.lazy="items.{{ $index }}.unit_price"
                                        min="0" 
                                        step="0.01"
                                        class="w-24"
                                    />
                                </flux:table.cell>
                                <flux:table.cell>
                                    {{ $item['tax_rate'] ?? 0 }}%
                                </flux:table.cell>
                                <flux:table.cell>
                                    <flux:text variant="strong">
                                        ${{ number_format($item['quantity'] * $item['unit_price'], 2) }}
                                    </flux:text>
                                </flux:table.cell>
                                <flux:table.cell>
                                    <div class="flex gap-1">
                                        <flux:button 
                                            size="sm" 
                                            variant="ghost" 
                                            icon="pencil"
                                            wire:click="editItem({{ $index }})"
                                        />
                                        <flux:button 
                                            size="sm" 
                                            variant="ghost" 
                                            icon="trash"
                                            wire:click="removeItem({{ $index }})"
                                            wire:confirm="Remove this item?"
                                        />
                                    </div>
                                </flux:table.cell>
                            </flux:table.flex flex-wrap>
                        @endforeach
                    </flux:table.rows>
                </flux:table>
            @else
                <div class="text-center py-12 bg-gray-50 rounded-lg">
                    <flux:icon name="shopping-cart" class="w-12 h-12 text-gray-400 mx-auto mb-4" />
                    <flux:heading size="md" class="mb-2">No items added</flux:heading>
                    <flux:text variant="muted">Add products or custom items to your invoice</flux:text>
                </div>
            @endif

            {{-- Product Selector Modal --}}
            <flux:modal wire:model="showProductSelector" class="min-w-[600px]">
                <div class="space-y-6">
                    <div>
                        <flux:heading size="lg">Select Products</flux:heading>
                        <flux:text class="mt-2">Choose products to add to your invoice</flux:text>
                    </div>
                    
                    <flux:input 
                        wire:model.live.debounce.300ms="searchProduct"
                        icon="magnifying-glass"
                        placeholder="Search products..."
                    />
                    
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        @forelse($this->products as $product)
                            <div class="flex justify-between items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                                 wire:click="addProduct({{ $product->id }})">
                                <div>
                                    <flux:text variant="strong">{{ $product->name }}</flux:text>
                                    @if($product->sku)
                                        <flux:text size="sm" variant="muted">SKU: {{ $product->sku }}</flux:text>
                                    @endif
                                    @if($product->description)
                                        <flux:text size="sm" variant="muted" class="block">
                                            {{ Str::limit($product->description, 100) }}
                                        </flux:text>
                                    @endif
                                </div>
                                <flux:text variant="strong">${{ number_format($product->price, 2) }}</flux:text>
                            </div>
                        @empty
                            <div class="text-center py-8">
                                <flux:text variant="muted">No products found</flux:text>
                            </div>
                        @endforelse
                    </div>
                    
                    <div class="flex gap-2">
                        <flux:spacer />
                        <flux:modal.close>
                            <flux:button variant="ghost">Cancel</flux:button>
                        </flux:modal.close>
                    </div>
                </div>
            </flux:modal>

            {{-- Custom Item Form Modal --}}
            <flux:modal wire:model="showCustomItemForm" class="md:w-96">
                <div class="space-y-6">
                    <div>
                        <flux:heading size="lg">{{ $editingItemIndex !== null ? 'Edit' : 'Add' }} Custom Item</flux:heading>
                        <flux:text class="mt-2">Enter the details for your custom item</flux:text>
                    </div>
                    
                    <flux:input 
                        wire:model="customItemName"
                        label="Item Name"
                        required
                    />
                    
                    <flux:textarea 
                        wire:model="customItemDescription"
                        label="Description"
                        rows="2"
                    />
                    
                    <div class="grid grid-cols-2 gap-4">
                        <flux:input 
                            type="number"
                            wire:model="customItemQuantity"
                            label="Quantity"
                            min="0.01"
                            step="0.01"
                            required
                        />
                        
                        <flux:input 
                            type="number"
                            wire:model="customItemUnitPrice"
                            label="Unit Price"
                            min="0"
                            step="0.01"
                            required
                        />
                    </div>
                    
                    <flux:input 
                        type="number"
                        wire:model="customItemTaxRate"
                        label="Tax Rate (%)"
                        min="0"
                        max="100"
                        step="0.01"
                    />
                    
                    <div class="flex gap-2">
                        <flux:spacer />
                        <flux:modal.close>
                            <flux:button variant="ghost">Cancel</flux:button>
                        </flux:modal.close>
                        <flux:button variant="primary" wire:click="addCustomItem">
                            {{ $editingItemIndex !== null ? 'Update' : 'Add' }} Item
                        </flux:button>
                    </div>
                </div>
            </flux:modal>
        </div>

        {{-- Step 3: Billing Configuration --}}
        <div x-show="@js($currentStep) === 'billing'" x-transition>
            <flux:heading size="lg" class="mb-6">Billing Configuration</flux:heading>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <flux:input 
                    type="number"
                    wire:model="payment_terms"
                    label="Payment Terms (days)"
                    min="0"
                />
                
                <flux:input 
                    type="number"
                    wire:model="late_fee_percent"
                    label="Late Fee (%)"
                    min="0"
                    max="100"
                    step="0.01"
                />
                
                <flux:select wire:model="discount_type" label="Discount Type">
                    <flux:select.option value="fixed">Fixed Amount</flux:select.option>
                    <flux:select.option value="percentage">Percentage</flux:select.option>
                </flux:select>
                
                <flux:input 
                    type="number"
                    wire:model="discount_amount"
                    label="Discount {{ $discount_type === 'percentage' ? '(%)' : '($)' }}"
                    min="0"
                    step="0.01"
                />
                
                <flux:input 
                    type="number"
                    wire:model="tax_rate"
                    label="Tax Rate (%)"
                    min="0"
                    max="100"
                    step="0.01"
                />
                
                <flux:switch 
                    wire:model="send_reminders"
                    label="Send payment reminders"
                />
                
                <div class="md:col-span-2">
                    <flux:textarea 
                        wire:model="notes"
                        label="Notes"
                        rows="3"
                        placeholder="Additional notes (optional)..."
                    />
                </div>
                
                <div class="md:col-span-2">
                    <flux:textarea 
                        wire:model="terms_conditions"
                        label="Terms & Conditions"
                        rows="3"
                        placeholder="Payment terms and conditions (optional)..."
                    />
                </div>
            </div>
        </div>

        {{-- Step 4: Review & Submit --}}
        <div x-show="@js($currentStep) === 'review'" x-transition>
            <flux:heading size="lg" class="mb-6">Review Invoice</flux:heading>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {{-- Invoice Details --}}
                <div class="lg:col-span-2 space-y-6">
                    {{-- Client & Invoice Info --}}
                    <flux:card>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <flux:text size="sm" variant="muted">Client</flux:text>
                                <flux:text variant="strong">
                                    @if($this->selectedClient)
                                        {{ $this->selectedClient->name }}
                                        @if($this->selectedClient->company_name)
                                            <br>{{ $this->selectedClient->company_name }}
                                        @endif
                                    @else
                                        Not selected
                                    @endif
                                </flux:text>
                            </div>
                            <div>
                                <flux:text size="sm" variant="muted">Invoice Number</flux:text>
                                <flux:text variant="strong">{{ $prefix }}{{ $number }}</flux:text>
                            </div>
                            <div>
                                <flux:text size="sm" variant="muted">Invoice Date</flux:text>
                                <flux:text variant="strong">
                                    {{ $invoice_date ? \Carbon\Carbon::parse($invoice_date)->format('M d, Y') : '-' }}
                                </flux:text>
                            </div>
                            <div>
                                <flux:text size="sm" variant="muted">Due Date</flux:text>
                                <flux:text variant="strong">
                                    {{ $due_date ? \Carbon\Carbon::parse($due_date)->format('M d, Y') : '-' }}
                                </flux:text>
                            </div>
                        </div>
                    </flux:card>

                    {{-- Items List --}}
                    <flux:card>
                        <flux:heading size="md" class="mb-4">Items ({{ count($items) }})</flux:heading>
                        @forelse($items as $item)
                            <div class="flex justify-between items-start py-3 border-b last:border-0">
                                <div class="flex-1">
                                    <flux:text variant="strong">{{ $item['name'] }}</flux:text>
                                    @if(isset($item['description']) && $item['description'])
                                        <flux:text size="sm" variant="muted" class="block">
                                            {{ $item['description'] }}
                                        </flux:text>
                                    @endif
                                    <flux:text size="sm" variant="muted">
                                        {{ $item['quantity'] }} × ${{ number_format($item['unit_price'], 2) }}
                                    </flux:text>
                                </div>
                                <flux:text variant="strong">
                                    ${{ number_format($item['quantity'] * $item['unit_price'], 2) }}
                                </flux:text>
                            </div>
                        @empty
                            <flux:text variant="muted">No items added</flux:text>
                        @endforelse
                    </flux:card>
                </div>

                {{-- Pricing Summary --}}
                <div>
                    <flux:card class="sticky top-4">
                        <flux:heading size="md" class="mb-4">Invoice Summary</flux:heading>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <flux:text>Subtotal:</flux:text>
                                <flux:text variant="strong">${{ number_format($this->subtotal, 2) }}</flux:text>
                            </div>
                            
                            @if($this->discountAmount > 0)
                                <div class="flex justify-between">
                                    <flux:text>Discount:</flux:text>
                                    <flux:text class="text-green-600">-${{ number_format($this->discountAmount, 2) }}</flux:text>
                                </div>
                            @endif
                            
                            @if($this->taxAmount > 0)
                                <div class="flex justify-between">
                                    <flux:text>Tax ({{ $tax_rate }}%):</flux:text>
                                    <flux:text>${{ number_format($this->taxAmount, 2) }}</flux:text>
                                </div>
                            @endif
                            
                            <flux:separator />
                            
                            <div class="flex justify-between">
                                <flux:text variant="strong">Total:</flux:text>
                                <flux:text variant="strong" class="text-xl text-blue-600">
                                    ${{ number_format($this->total, 2) }}
                                </flux:text>
                            </div>
                        </div>
                    </flux:card>
                </div>
            </div>
        </div>

        {{-- Navigation Buttons --}}
        <div class="flex justify-between items-center mt-8 pt-6 border-t">
            <flux:button 
                variant="ghost" 
                icon="arrow-left"
                wire:click="previousStep"
                :disabled="$currentStep === 'details'"
            >
                Previous
            </flux:button>

            <div class="flex gap-2">
                <flux:button 
                    variant="outline"
                    icon="document-duplicate"
                    wire:click="saveAsDraft"
                >
                    Save as Draft
                </flux:button>
                
                @if($currentStep !== 'review')
                    <flux:button 
                        variant="primary" 
                        icon:trailing="arrow-right"
                        wire:click="nextStep"
                    >
                        Next
                    </flux:button>
                @else
                    <flux:button 
                        variant="primary" 
                        icon="check"
                        wire:click="createInvoice"
                    >
                        Create Invoice
                    </flux:button>
                @endif
            </div>
        </div>
    </flux:card>
</div>