@extends('layouts.app')

@section('title', 'Ticket Templates')

@section('content')
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-8 sm:px-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Ticket Templates</h3>
                        <p class="mt-1 max-w-2xl text-sm text-gray-500">Manage reusable ticket templates for consistent service delivery.</p>
                    </div>
                    <div class="flex space-x-3">
                        <a href="{{ route('tickets.templates.export', request()->query()) }}" 
                           class="inline-flex items-center px-6 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Export CSV
                        </a>
                        <a href="{{ route('tickets.templates.create') }}" 
                           class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            New Template
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-6 py-8 sm:px-6">
                <form method="GET" action="{{ route('tickets.templates.index') }}" class="space-y-4">
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                        <!-- Search -->
                        <div>
                            <label for="search" class="block text-sm font-medium text-gray-700">Search</flux:label>
                            <input type="text" 
                                   name="search" 
                                   id="search" 
                                   value="{{ request('search') }}"
                                   placeholder="Template name, description..."
                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>

                        <!-- Category -->
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Category</flux:label>
                            <select name="category" 
                                    id="category" 
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="">All Categories</option>
                                @foreach($categories as $category)
                                    <option value="{{ $category }}" {{ request('category') === $category ? 'selected' : '' }}>
                                        {{ $category }}
                                    </option>
                                @endforeach
                            </flux:select>
                        </div>

                        <!-- Priority -->
                        <div>
                            <label for="priority" class="block text-sm font-medium text-gray-700">Priority</flux:label>
                            <select name="priority" 
                                    id="priority" 
                                    class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="">All Priorities</option>
                                <option value="Low" {{ request('priority') === 'Low' ? 'selected' : '' }}>Low</option>
                                <option value="Medium" {{ request('priority') === 'Medium' ? 'selected' : '' }}>Medium</option>
                                <option value="High" {{ request('priority') === 'High' ? 'selected' : '' }}>High</option>
                                <option value="Critical" {{ request('priority') === 'Critical' ? 'selected' : '' }}>Critical</option>
                            </flux:select>
                        </div>

                        <!-- Actions -->
                        <div class="flex items-end space-x-3">
                            <button type="submit" 
                                    class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Filter
                            </flux:button>
                            <a href="{{ route('tickets.templates.index') }}" 
                               class="inline-flex items-center px-6 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Clear
                            </a>
                        </div>
                    </div>

                    <!-- Status Filter -->
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" 
                                   name="active" 
                                   value="" 
                                   {{ request('active') === '' ? 'checked' : '' }}
                                   class="form-radio text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">All Templates</span>
                        </flux:label>
                        <label class="inline-flex items-center">
                            <input type="radio" 
                                   name="active" 
                                   value="1" 
                                   {{ request('active') === '1' ? 'checked' : '' }}
                                   class="form-radio text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">Active Only</span>
                        </flux:label>
                        <label class="inline-flex items-center">
                            <input type="radio" 
                                   name="active" 
                                   value="0" 
                                   {{ request('active') === '0' ? 'checked' : '' }}
                                   class="form-radio text-indigo-600">
                            <span class="ml-2 text-sm text-gray-700">Inactive Only</span>
                        </flux:label>
                    </div>
                </form>
            </div>
        </div>

        <!-- Templates Grid -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-8 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Templates 
                    <span class="text-sm text-gray-500">({{ $templates->total() }} total)</span>
                </h3>
            </div>
            
            @if($templates->count() > 0)
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 p-6">
                    @foreach($templates as $template)
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                            <div class="p-6">
                                <!-- Header -->
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-3">
                                        <div class="flex-shrink-0">
                                            <div class="h-10 w-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                                                <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-medium text-gray-900">{{ $template->name }}</h3>
                                            @if($template->category)
                                                <p class="text-sm text-gray-500">{{ $template->category }}</p>
                                            @endif
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        @if($template->is_active)
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                Active
                                            </span>
                                        @else
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                                Inactive
                                            </span>
                                        @endif
                                    </div>
                                </div>

                                <!-- Priority & Statistics -->
                                <div class="flex items-center justify-between mb-6">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium @if($template->priority === 'Critical') bg-red-100 text-red-800 @elseif($template->priority === 'High') bg-orange-100 text-orange-800 @elseif($template->priority === 'Medium') bg-yellow-100 text-yellow-800 @elseif($template->priority === 'Low') bg-green-100 text-green-800 @else bg-gray-100 text-gray-800 @endif">
                                        {{ $template->priority ?? 'Medium' }}
                                    </span>
                                    <div class="flex items-center text-sm text-gray-500">
                                        <svg class="mr-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        {{ $template->tickets_count ?? 0 }} tickets
                                    </div>
                                </div>

                                <!-- Description -->
                                @if($template->description)
                                    <p class="text-sm text-gray-600 mb-6 line-clamp-2">{{ $template->description }}</p>
                                @endif

                                <!-- Subject Preview -->
                                <div class="mb-6">
                                    <p class="text-sm font-medium text-gray-700">Subject:</p>
                                    <p class="text-sm text-gray-600 truncate">{{ $template->subject_template }}</p>
                                </div>

                                <!-- Assignee & Time Estimate -->
                                <div class="flex items-center justify-between text-sm text-gray-500 mb-6">
                                    @if($template->defaultAssignee)
                                        <div class="flex items-center">
                                            <div class="h-6 w-6 rounded-full bg-gray-200 flex items-center justify-center">
                                                <span class="text-xs text-gray-600">{{ strtoupper(substr($template->defaultAssignee->name, 0, 1)) }}</span>
                                            </div>
                                            <span class="ml-2">{{ $template->defaultAssignee->name }}</span>
                                        </div>
                                    @else
                                        <span class="text-gray-400">No default assignee</span>
                                    @endif
                                    @if($template->estimated_hours)
                                        <span>{{ $template->estimated_hours }}h est.</span>
                                    @endif
                                </div>

                                <!-- Actions -->
                                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                                    <div class="flex space-x-3">
                                        <a href="{{ route('tickets.templates.show', $template) }}" 
                                           class="text-indigo-600 hover:text-indigo-500 text-sm font-medium">
                                            View
                                        </a>
                                        <a href="{{ route('tickets.templates.edit', $template) }}" 
                                           class="text-indigo-600 hover:text-indigo-500 text-sm font-medium">
                                            Edit
                                        </a>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button type="button" 
                                                onclick="duplicateTemplate({{ $template->id }})"
                                                class="text-gray-600 hover:text-gray-500 text-sm font-medium">
                                            Duplicate
                                        </flux:button>
                                        <form method="POST" 
                                              action="{{ route('tickets.templates.create-ticket', $template) }}" 
                                              class="inline">
                                            @csrf
                                            <button type="button" 
                                                    onclick="showCreateTicketModal({{ $template->id }})"
                                                    class="inline-flex items-center px-6 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                                                Use Template
                                            </flux:button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    @endforeach
                </div>

                <!-- Pagination -->
                <div class="bg-white px-6 py-6 border-t border-gray-200 sm:px-6">
                    {{ $templates->appends(request()->query())->links() }}
                </div>
            @else
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No templates found</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a reusable ticket template.</p>
                    <div class="mt-6">
                        <a href="{{ route('tickets.templates.create') }}" 
                           class="inline-flex items-center px-6 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            New Template
                        </a>
                    </div>
                </div>
            @endif
        </div>
    </div>
</div>

<!-- Create Ticket Modal -->
<div id="createTicketModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-6 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="createTicketForm" method="POST">
                @csrf
                <div class="bg-white px-6 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-6 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Create Ticket from Template
                            </h3>
                            <div class="mt-6 space-y-4">
                                <div>
                                    <label for="modal_client_id" class="block text-sm font-medium text-gray-700">Client *</flux:label>
                                    <select name="client_id" id="modal_client_id" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="">Select a client...</option>
                                        <!-- Will be populated via JavaScript -->
                                    </flux:select>
                                </div>
                                <div>
                                    <label for="modal_assigned_to" class="block text-sm font-medium text-gray-700">Assignee</flux:label>
                                    <select name="assigned_to" id="modal_assigned_to" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="">Select assignee...</option>
                                        <!-- Will be populated via JavaScript -->
                                    </flux:select>
                                </div>
                                <div>
                                    <label for="modal_scheduled_at" class="block text-sm font-medium text-gray-700">Schedule For</flux:label>
                                    <input type="datetime-local" name="scheduled_at" id="modal_scheduled_at" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-6 sm:px-6 sm:flex sm:flex-flex flex-wrap -mx-4-reverse">
                    <button type="submit" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Create Ticket
                    </flux:button>
                    <button type="button" 
                            onclick="closeCreateTicketModal()"
                            class="mt-6 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-6 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </flux:button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showCreateTicketModal(templateId) {
    const modal = document.getElementById('createTicketModal');
    const form = document.getElementById('createTicketForm');
    
    // Set form action
    form.action = `/tickets/templates/${templateId}/create-ticket`;
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Load client and user options (would normally be AJAX calls)
    // For now, we'll populate with static data
    populateModalSelects();
}

function closeCreateTicketModal() {
    document.getElementById('createTicketModal').classList.add('hidden');
}

function duplicateTemplate(templateId) {
    const name = prompt('Enter name for the duplicate template:');
    if (name) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/tickets/templates/${templateId}/duplicate`;
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = '_token';
        csrf.value = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        const nameInput = document.createElement('input');
        nameInput.type = 'hidden';
        nameInput.name = 'name';
        nameInput.value = name;
        
        form.appendChild(csrf);
        form.appendChild(nameInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function populateModalSelects() {
    // This would normally fetch data via AJAX
    // For demonstration, we'll populate with sample data
    const clientSelect = document.getElementById('modal_client_id');
    const assigneeSelect = document.getElementById('modal_assigned_to');
    
    // Clear existing options except first
    clientSelect.innerHTML = '<option value="">Select a client...</option>';
    assigneeSelect.innerHTML = '<option value="">Select assignee...</option>';
    
    // Would populate from server data
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('createTicketModal');
    if (event.target === modal) {
        closeCreateTicketModal();
    }
});
</script>
@endsection