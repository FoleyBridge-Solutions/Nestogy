#!/usr/bin/env bash
set -e

echo "ğŸš€ Deployment started..."

# Navigate to site directory (Laravel Cloud auto-handles this)
cd $FORGE_SITE_PATH

# Pull latest code (Laravel Cloud does this automatically)
echo "ğŸ“¦ Installing dependencies..."
composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

# Run database migrations
echo "ğŸ—„ï¸  Running migrations..."
php artisan migrate --force

# âœ¨ Ensure permissions system is ready
echo "ğŸ” Ensuring permissions system integrity..."
php artisan permissions:ensure --sync

# Clear and cache configuration
echo "ğŸ—‚ï¸  Caching configuration..."
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Clear application cache
echo "ğŸ§¹ Clearing application cache..."
php artisan cache:clear

# Restart queue workers (if using queues)
echo "â™»ï¸  Restarting queue workers..."
php artisan queue:restart

# Optimize for production
echo "âš¡ Optimizing for production..."
php artisan optimize

echo "âœ… Deployment finished successfully!"
